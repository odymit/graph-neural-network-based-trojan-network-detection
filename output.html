<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #000080; text-decoration-color: #000080}
.r2 {font-weight: bold}
.r3 {font-weight: bold; font-style: italic}
.r4 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r5 {color: #800000; text-decoration-color: #800000; font-weight: bold}
.r6 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r7 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r8 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r9 {background-color: #f8f8f8}
.r10 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r11 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r12 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r13 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8}
.r14 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r15 {color: #408080; text-decoration-color: #408080; background-color: #f8f8f8; font-style: italic}
.r16 {color: #19177c; text-decoration-color: #19177c; background-color: #f8f8f8}
.r17 {color: #008080; text-decoration-color: #008080; font-weight: bold}
.r18 {font-style: italic}
.r19 {color: #bb6688; text-decoration-color: #bb6688; background-color: #f8f8f8; font-weight: bold}
.r20 {color: #d2413a; text-decoration-color: #d2413a; background-color: #f8f8f8; font-weight: bold}
.r21 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8; font-style: italic}
.r22 {color: #0000ff; text-decoration-color: #0000ff}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<html>
<body>
    <code>
        <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                 Memory usage: <span class="r1">████████████████</span> (max:   1.77GB, growth rate:  41%)                                 
                                    run_act_2class_opt.py: % of time =  70.69% out of   5.84s.                                     
       ╷       ╷       ╷       ╷       ╷       ╷       ╷              ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r2">Time   </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">Memory </span>│<span class="r2">–––––– </span>│<span class="r2">–––––––––––   </span>│<span class="r2">Copy   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> Line </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">native</span><span class="r2"> </span>│<span class="r3">system</span><span class="r2"> </span>│<span class="r3">GPU</span><span class="r2">    </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">net</span><span class="r2">    </span>│<span class="r3">timeline</span><span class="r2">/%    </span>│<span class="r3">(MB/s)</span><span class="r2"> </span>│<span class="r2">run_act_2class_opt.py                              </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r4">    1 </span>│<span class="r5">   16%</span> │<span class="r5">   53%</span> │       │<span class="r5"> 70%</span>   │   8%  │  142M │<span class="r5">▁▁▁▁   8%</span>     │    20 │<span class="r6">import</span><span class="r7"> </span><span class="r8">dgl</span><span class="r9">                                        </span>  
 <span class="r4">    2 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">numpy</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">np</span><span class="r9">                                </span>  
 <span class="r4">    3 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch</span><span class="r9">                                      </span>  
 <span class="r4">    4 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">torch</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> nn </span><span class="r9">                             </span>  
 <span class="r4">    5 </span>│    1% │       │       │  5%   │       │    6M │▁▁▁▁          │     1 │<span class="r6">import</span><span class="r7"> </span><span class="r8">torchvision</span><span class="r9">                                </span>  
 <span class="r4">    6 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torchvision.transforms</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">transforms</span><span class="r9">       </span>  
 <span class="r4">    7 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">utils_basic</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> load_dataset_setting, eval</span>  
 <span class="r4">    8 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">os</span><span class="r9">                                         </span>  
 <span class="r4">    9 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">datetime</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> datetime</span><span class="r9">                     </span>  
 <span class="r4">   10 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">json</span><span class="r9">                                       </span>  
 <span class="r4">   11 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">argparse</span><span class="r9">                                   </span>  
 <span class="r4">   12 </span>│       │       │       │       │       │    0M │▁▁            │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">utils_gnn</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> cnn2graph_activation</span><span class="r9">        </span>  
 <span class="r4">   13 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">utils_activation</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> activation_passing</span><span class="r9">   </span>  
 <span class="r4">   14 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">tqdm</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> tqdm</span><span class="r9">                             </span>  
 <span class="r4">   15 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">utils_gnn</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> GIN</span><span class="r9">                         </span>  
 <span class="r4">   16 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">line_profiler</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> LineProfiler</span><span class="r9">            </span>  
 <span class="r4">   17 </span>│       │       │       │       │       │       │              │       │<span class="r7">parser </span><span class="r10">=</span><span class="r7"> argparse</span><span class="r10">.</span><span class="r7">ArgumentParser()</span><span class="r9">                </span>  
 <span class="r4">   18 </span>│       │       │       │       │       │       │              │       │<span class="r7">parser</span><span class="r10">.</span><span class="r7">add_argument(</span><span class="r11">&#x27;--task&#x27;</span><span class="r7">, </span><span class="r12">type</span><span class="r10">=</span><span class="r12">str</span><span class="r7">, required</span><span class="r10">=</span><span class="r6">T</span>  
 <span class="r4">   19 </span>│       │       │       │       │       │       │              │       │<span class="r7">parser</span><span class="r10">.</span><span class="r7">add_argument(</span><span class="r11">&#x27;--model&#x27;</span><span class="r7">, </span><span class="r12">type</span><span class="r10">=</span><span class="r12">str</span><span class="r7">, required</span><span class="r10">=</span>  
 <span class="r4">   20 </span>│       │       │       │       │       │       │              │       │<span class="r7">parser</span><span class="r10">.</span><span class="r7">add_argument(</span><span class="r11">&#x27;--n&#x27;</span><span class="r7">, </span><span class="r12">type</span><span class="r10">=</span><span class="r12">str</span><span class="r7">, required</span><span class="r10">=</span><span class="r6">Fals</span>  
 <span class="r4">   21 </span>│       │       │       │       │       │       │              │       │<span class="r7">parser</span><span class="r10">.</span><span class="r7">add_argument(</span><span class="r11">&#x27;--save_dir&#x27;</span><span class="r7">, </span><span class="r12">type</span><span class="r10">=</span><span class="r12">str</span><span class="r7">, requir</span>  
 <span class="r4">   22 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   23 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">MyBackdoorDataset</span><span class="r7">(BackdoorDataset):</span><span class="r9">         </span>  
 <span class="r4">   24 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__getitem__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, idx):</span><span class="r9">                   </span>  
 <span class="r4">   25 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> (</span><span class="r14">not</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only </span><span class="r14">and</span><span class="r7"> idx </span><span class="r10">&lt;</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">c</span>  
 <span class="r4">   26 </span>│       │       │       │       │       │       │              │       │<span class="r7">            troj_label </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                        </span>  
 <span class="r4">   27 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># Return non-trojaned data</span><span class="r9">            </span>  
 <span class="r4">   28 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">need_pad:</span><span class="r9">                     </span>  
 <span class="r4">   29 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># In NLP task we need to pad input</span>  
 <span class="r4">   30 </span>│       │       │       │       │       │       │              │       │<span class="r7">                p_size </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">atk_setting[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">      </span>  
 <span class="r4">   31 </span>│       │       │       │       │       │       │              │       │<span class="r7">                X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">choic</span>  
 <span class="r4">   32 </span>│       │       │       │       │       │       │              │       │<span class="r7">                X_padded </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">cat([X, torch</span><span class="r10">.</span><span class="r7">Lon</span>  
 <span class="r4">   33 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">return</span><span class="r7"> X_padded, y, troj_label</span><span class="r9">    </span>  
 <span class="r4">   34 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">   35 </span>│       │       │       │       │       │       │              │       │<span class="r7">                X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">choic</span>  
 <span class="r4">   36 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">return</span><span class="r7"> X, y, troj_label</span><span class="r9">           </span>  
 <span class="r4">   37 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   38 </span>│       │       │       │       │       │       │              │       │<span class="r7">        troj_label </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                            </span>  
 <span class="r4">   39 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only:</span><span class="r9">                         </span>  
 <span class="r4">   40 </span>│       │       │       │       │       │       │              │       │<span class="r7">            X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choic</span>  
 <span class="r4">   41 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   42 </span>│       │       │       │       │       │       │              │       │<span class="r7">            X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choic</span>  
 <span class="r4">   43 </span>│       │       │       │       │       │       │              │       │<span class="r7">        X_new, y_new </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">troj_gen_func(X, y, </span><span class="r12">se</span>  
 <span class="r4">   44 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> X_new, y_new, troj_label</span><span class="r9">           </span>  
 <span class="r4">   45 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   46 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   47 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">get_base_model</span><span class="r7">():</span><span class="r9">                             </span>  
 <span class="r4">   48 </span>│       │       │       │       │       │       │              │       │<span class="r7">    x </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;./shadow_model_ckpt/mnist/models5/shadow_</span>  
 <span class="r4">   49 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># load model </span><span class="r9">                                 </span>  
 <span class="r4">   50 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># Model = load_spec_model(father_model, &#x27;5&#x27;)</span><span class="r9">  </span>  
 <span class="r4">   51 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.mnist_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> Model6 </span><span class="r6">a</span>  
 <span class="r4">   52 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model </span><span class="r10">=</span><span class="r7"> Model(gpu</span><span class="r10">=</span><span class="r6">True</span><span class="r7">)</span><span class="r9">                       </span>  
 <span class="r4">   53 </span>│       │       │       │       │       │       │              │       │<span class="r7">    params </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">load(x)</span><span class="r9">                        </span>  
 <span class="r4">   54 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">load_state_dict(params)</span><span class="r9">                 </span>  
 <span class="r4">   55 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">del</span><span class="r7"> params</span><span class="r9">                                    </span>  
 <span class="r4">   56 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> model</span><span class="r9">                                  </span>  
 <span class="r4">   57 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   58 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">get_graph</span><span class="r7">(model):</span><span class="r9">                             </span>  
 <span class="r4">   59 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># load model detail </span><span class="r9">                      </span>  
 <span class="r4">   60 </span>│       │       │       │       │       │       │              │       │<span class="r7">        model_detail </span><span class="r10">=</span><span class="r7"> {}</span><span class="r9">                         </span>  
 <span class="r4">   61 </span>│       │       │       │       │       │       │              │       │<span class="r7">        model_detail_path </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&quot;./intermediate_data/m</span>  
 <span class="r4">   62 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">import</span><span class="r7"> </span><span class="r8">json</span><span class="r9">                               </span>  
 <span class="r4">   63 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">with</span><span class="r7"> </span><span class="r12">open</span><span class="r7">(model_detail_path, </span><span class="r11">&#x27;r&#x27;</span><span class="r7">) </span><span class="r6">as</span><span class="r7"> f:</span><span class="r9">   </span>  
 <span class="r4">   64 </span>│       │       │       │       │       │       │              │       │<span class="r7">            model_detail </span><span class="r10">=</span><span class="r7"> json</span><span class="r10">.</span><span class="r7">load(f)</span><span class="r9">           </span>  
 <span class="r4">   65 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(model_detail)</span><span class="r9">                     </span>  
 <span class="r4">   66 </span>│       │       │       │       │       │       │              │       │<span class="r7">        g </span><span class="r10">=</span><span class="r7"> cnn2graph_activation(model, model_deta</span>  
 <span class="r4">   67 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># dgl.save_graphs(&#x27;./intermediate_data/gra</span>  
 <span class="r4">   68 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">del</span><span class="r7"> model_detail</span><span class="r9">                          </span>  
 <span class="r4">   69 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> g </span><span class="r9">                                 </span>  
 <span class="r4">   70 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   71 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   72 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">evaluate</span><span class="r7">(dataloader, device, model, base_model</span>  
 <span class="r4">   73 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">eval()</span><span class="r9">                                  </span>  
 <span class="r4">   74 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                     </span>  
 <span class="r4">   75 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_correct </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                             </span>  
 <span class="r4">   76 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> i, data </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(tqdm(dataloader)):</span><span class="r9">   </span>  
 <span class="r4">   77 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x_in </span><span class="r10">=</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                               </span>  
 <span class="r4">   78 </span>│       │       │       │       │       │       │              │       │<span class="r7">        troj_y_in </span><span class="r10">=</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                          </span>  
 <span class="r4">   79 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(data) </span><span class="r10">&gt;</span><span class="r7"> </span><span class="r10">2</span><span class="r7">:</span><span class="r9">                         </span>  
 <span class="r4">   80 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x_in, _, troj_y_in</span><span class="r10">=</span><span class="r7"> data</span><span class="r9">              </span>  
 <span class="r4">   81 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   82 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x_in, _ </span><span class="r10">=</span><span class="r7"> data</span><span class="r9">                        </span>  
 <span class="r4">   83 </span>│       │       │       │       │       │       │              │       │<span class="r7">            troj_y_in </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(</span><span class="r10">0</span><span class="r7">)</span><span class="r9">           </span>  
 <span class="r4">   84 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> i </span><span class="r10">&gt;</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> :</span><span class="r9">                                </span>  
 <span class="r4">   85 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">break</span><span class="r9">                                 </span>  
 <span class="r4">   86 </span>│       │       │       │       │       │       │              │       │<span class="r7">        label </span><span class="r10">=</span><span class="r7"> troj_y_in</span><span class="r9">                         </span>  
 <span class="r4">   87 </span>│       │       │       │       │       │       │              │       │<span class="r7">        label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">                  </span>  
 <span class="r4">   88 </span>│       │       │       │       │       │       │              │       │<span class="r7">        g </span><span class="r10">=</span><span class="r7"> get_graph(base_model)</span><span class="r9">                 </span>  
 <span class="r4">   89 </span>│       │       │       │       │       │       │              │       │<span class="r7">        message_passed_g </span><span class="r10">=</span><span class="r7"> activation_passing(x_in</span>  
 <span class="r4">   90 </span>│       │       │       │       │       │       │              │       │<span class="r7">        message_passed_g </span><span class="r10">=</span><span class="r7"> message_passed_g</span><span class="r10">.</span><span class="r7">to(dev</span>  
 <span class="r4">   91 </span>│       │       │       │       │       │       │              │       │<span class="r7">        feat </span><span class="r10">=</span><span class="r7"> message_passed_g</span><span class="r10">.</span><span class="r7">ndata</span><span class="r10">.</span><span class="r7">pop(</span><span class="r11">&quot;ft&quot;</span><span class="r7">)</span><span class="r9">   </span>  
 <span class="r4">   92 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                                </span>  
 <span class="r4">   93 </span>│       │       │       │       │       │       │              │       │<span class="r7">        logits </span><span class="r10">=</span><span class="r7"> model(message_passed_g, feat</span><span class="r10">.</span><span class="r7">view</span>  
 <span class="r4">   94 </span>│       │       │       │       │       │       │              │       │<span class="r7">        _, predicted </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">max(logits, </span><span class="r10">1</span><span class="r7">)</span><span class="r9">       </span>  
 <span class="r4">   95 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_correct </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">==</span><span class="r7"> label)</span><span class="r10">.</span><span class="r7">item</span>  
 <span class="r4">   96 </span>│       │       │       │       │       │       │              │       │<span class="r7">    acc </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1.0</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> total_correct </span><span class="r10">/</span><span class="r7"> total</span><span class="r9">             </span>  
 <span class="r4">   97 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> acc, total</span><span class="r9">                             </span>  
 <span class="r4">   98 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   99 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  100 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">train_2class_classification_model</span><span class="r7">(model, base_</span>  
 <span class="r4">  101 </span>│       │       │       │       │       │       │              │       │<span class="r7">    loss_fcn </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">CrossEntropyLoss()</span><span class="r9">              </span>  
 <span class="r4">  102 </span>│       │       │       │       │       │       │              │       │<span class="r7">    optimizer </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">optim</span><span class="r10">.</span><span class="r7">Adam(model</span><span class="r10">.</span><span class="r7">parameters(</span>  
 <span class="r4">  103 </span>│       │       │       │       │       │       │              │       │<span class="r7">    scheduler </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">optim</span><span class="r10">.</span><span class="r7">lr_scheduler</span><span class="r10">.</span><span class="r7">StepLR(op</span>  
 <span class="r4">  104 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  105 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># train loop</span><span class="r9">                                  </span>  
 <span class="r4">  106 </span>│       │       │       │       │       │       │              │       │<span class="r7">    flag </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                                  </span>  
 <span class="r4">  107 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> epoch </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(epoch_num):</span><span class="r9">                </span>  
 <span class="r4">  108 </span>│       │       │       │       │       │       │              │       │<span class="r7">        model</span><span class="r10">.</span><span class="r7">train()</span><span class="r9">                             </span>  
 <span class="r4">  109 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_loss </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                            </span>  
 <span class="r4">  110 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, (x_in, y_in, troj_y_in) </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerat</span>  
 <span class="r4">  111 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># print(i)</span><span class="r9">                            </span>  
 <span class="r4">  112 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># if i &gt; 2:</span><span class="r9">                           </span>  
 <span class="r4">  113 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15">#     flag = True</span><span class="r9">                     </span>  
 <span class="r4">  114 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15">#     break</span><span class="r9">                           </span>  
 <span class="r4">  115 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># else:</span><span class="r9">                               </span>  
 <span class="r4">  116 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15">#     continue</span><span class="r9">                        </span>  
 <span class="r4">  117 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> troj_y_in</span><span class="r9">                     </span>  
 <span class="r4">  118 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">              </span>  
 <span class="r4">  119 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># init a graph</span><span class="r9">                        </span>  
 <span class="r4">  120 </span>│       │       │       │       │       │       │              │       │<span class="r7">            g </span><span class="r10">=</span><span class="r7"> get_graph(base_model)</span><span class="r9">             </span>  
 <span class="r4">  121 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># get message passed graph</span><span class="r9">            </span>  
 <span class="r4">  122 </span>│       │       │       │       │       │       │              │       │<span class="r7">            message_passed_g </span><span class="r10">=</span><span class="r7"> activation_passing(</span>  
 <span class="r4">  123 </span>│       │       │       │       │       │       │              │       │<span class="r7">            message_passed_g </span><span class="r10">=</span><span class="r7"> message_passed_g</span><span class="r10">.</span><span class="r7">to</span>  
 <span class="r4">  124 </span>│       │       │       │       │       │       │              │       │<span class="r7">            feat </span><span class="r10">=</span><span class="r7"> message_passed_g</span><span class="r10">.</span><span class="r7">ndata</span><span class="r10">.</span><span class="r7">pop(</span><span class="r11">&quot;ft&quot;</span>  
 <span class="r4">  125 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># print(&quot;feat:&quot;, feat.shape)</span><span class="r9">          </span>  
 <span class="r4">  126 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># graph classification model learning </span>  
 <span class="r4">  127 </span>│       │       │       │       │       │       │              │       │<span class="r7">            logits </span><span class="r10">=</span><span class="r7"> model(message_passed_g, feat</span><span class="r10">.</span>  
 <span class="r4">  128 </span>│       │       │       │       │       │       │              │       │<span class="r7">            loss </span><span class="r10">=</span><span class="r7"> loss_fcn(logits, label)</span><span class="r9">        </span>  
 <span class="r4">  129 </span>│       │       │       │       │       │       │              │       │<span class="r7">            optimizer</span><span class="r10">.</span><span class="r7">zero_grad()</span><span class="r9">                 </span>  
 <span class="r4">  130 </span>│       │       │       │       │       │       │              │       │<span class="r7">            loss</span><span class="r10">.</span><span class="r7">backward()</span><span class="r9">                       </span>  
 <span class="r4">  131 </span>│       │       │       │       │       │       │              │       │<span class="r7">            optimizer</span><span class="r10">.</span><span class="r7">step()</span><span class="r9">                      </span>  
 <span class="r4">  132 </span>│       │       │       │       │       │       │              │       │<span class="r7">            total_loss </span><span class="r10">+=</span><span class="r7"> loss</span><span class="r10">.</span><span class="r7">item()</span><span class="r9">             </span>  
 <span class="r4">  133 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">break</span><span class="r9">                                 </span>  
 <span class="r4">  134 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># if flag:</span><span class="r9">                                </span>  
 <span class="r4">  135 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15">#     break</span><span class="r9">                               </span>  
 <span class="r4">  136 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">break</span><span class="r9">                                     </span>  
 <span class="r4">  137 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># scheduler.step()</span><span class="r9">                        </span>  
 <span class="r4">  138 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># train_acc = evaluate(trainloader, device</span>  
 <span class="r4">  139 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># valid_acc_benign = evaluate(testloader_b</span>  
 <span class="r4">  140 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># valid_acc_mal = evaluate(testloader_mal,</span>  
 <span class="r4">  141 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(</span><span class="r9">                                  </span>  
 <span class="r4">  142 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15">#     &quot;Epoch {:05d} | Loss {:.4f} | Train </span>  
 <span class="r4">  143 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15">#         epoch, total_loss, train_acc, va</span>  
 <span class="r4">  144 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15">#     )</span><span class="r9">                                   </span>  
 <span class="r4">  145 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># )</span><span class="r9">                                       </span>  
 <span class="r4">  146 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(epoch, total_loss, train_acc, vali</span>  
 <span class="r4">  147 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r9">                                          </span>  
 <span class="r4">  148 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  149 </span>│       │       │       │       │       │       │              │       │<span class="r6">if</span><span class="r7"> </span><span class="r16">__name__</span><span class="r7"> </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;__main__&#x27;</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  150 </span>│       │       │       │       │       │       │              │       │<span class="r7">    args </span><span class="r10">=</span><span class="r7"> parser</span><span class="r10">.</span><span class="r7">parse_args()</span><span class="r9">                    </span>  
 <span class="r4">  151 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> </span><span class="r14">not</span><span class="r7"> args</span><span class="r10">.</span><span class="r7">model:</span><span class="r9">                            </span>  
 <span class="r4">  152 </span>│       │       │       │       │       │       │              │       │<span class="r7">        args</span><span class="r10">.</span><span class="r7">model </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;0&#x27;</span><span class="r9">                          </span>  
 <span class="r4">  153 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> </span><span class="r14">not</span><span class="r7"> args</span><span class="r10">.</span><span class="r7">save_dir:</span><span class="r9">                         </span>  
 <span class="r4">  154 </span>│       │       │       │       │       │       │              │       │<span class="r7">        args</span><span class="r10">.</span><span class="r7">save_dir </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;./&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  155 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  156 </span>│       │       │       │       │       │       │              │       │<span class="r7">    GPU </span><span class="r10">=</span><span class="r7"> </span><span class="r6">True</span><span class="r9">                                    </span>  
 <span class="r4">  157 </span>│       │       │       │       │       │       │              │       │<span class="r7">    SHADOW_PROP </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.02</span><span class="r9">                            </span>  
 <span class="r4">  158 </span>│       │       │       │       │       │       │              │       │<span class="r7">    TARGET_PROP </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.5</span><span class="r9">                             </span>  
 <span class="r4">  159 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># SHADOW_NUM = 2048+256</span><span class="r9">                       </span>  
 <span class="r4">  160 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> args</span><span class="r10">.</span><span class="r7">n:</span><span class="r9">                                    </span>  
 <span class="r4">  161 </span>│       │       │       │       │       │       │              │       │<span class="r7">        SHADOW_NUM </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">(args</span><span class="r10">.</span><span class="r7">n)</span><span class="r9">                  </span>  
 <span class="r4">  162 </span>│       │       │       │       │       │       │              │       │<span class="r7">        TARGET_NUM </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">(args</span><span class="r10">.</span><span class="r7">n)</span><span class="r9">                  </span>  
 <span class="r4">  163 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  164 </span>│       │       │       │       │       │       │              │       │<span class="r7">        SHADOW_NUM </span><span class="r10">=</span><span class="r7"> </span><span class="r10">2048+256</span><span class="r9">                     </span>  
 <span class="r4">  165 </span>│       │       │       │       │       │       │              │       │<span class="r7">        TARGET_NUM </span><span class="r10">=</span><span class="r7"> </span><span class="r10">256</span><span class="r9">                          </span>  
 <span class="r4">  166 </span>│       │       │       │       │       │       │              │       │<span class="r7">    np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">seed(</span><span class="r10">0</span><span class="r7">)</span><span class="r9">                             </span>  
 <span class="r4">  167 </span>│       │       │       │       │       │       │              │       │<span class="r7">    torch</span><span class="r10">.</span><span class="r7">manual_seed(</span><span class="r10">0</span><span class="r7">)</span><span class="r9">                          </span>  
 <span class="r4">  168 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> GPU:</span><span class="r9">                                       </span>  
 <span class="r4">  169 </span>│       │       │       │       │       │       │              │       │<span class="r7">        torch</span><span class="r10">.</span><span class="r7">cuda</span><span class="r10">.</span><span class="r7">manual_seed_all(</span><span class="r10">0</span><span class="r7">)</span><span class="r9">             </span>  
 <span class="r4">  170 </span>│       │       │       │       │       │       │              │       │<span class="r7">        torch</span><span class="r10">.</span><span class="r7">backends</span><span class="r10">.</span><span class="r7">cudnn</span><span class="r10">.</span><span class="r7">deterministic </span><span class="r10">=</span><span class="r7"> </span><span class="r6">True</span><span class="r9"> </span>  
 <span class="r4">  171 </span>│       │       │       │       │       │       │              │       │<span class="r7">        torch</span><span class="r10">.</span><span class="r7">backends</span><span class="r10">.</span><span class="r7">cudnn</span><span class="r10">.</span><span class="r7">benchmark </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">    </span>  
 <span class="r4">  172 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  173 </span>│       │       │       │       │       │       │              │       │<span class="r7">    BATCH_SIZE, N_EPOCH, trainset, testset, is_bin</span>  
 <span class="r4">  174 </span>│       │       │       │       │       │       │              │       │<span class="r7">    tot_num </span><span class="r10">=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(trainset)</span><span class="r9">                       </span>  
 <span class="r4">  175 </span>│       │       │       │       │       │       │              │       │<span class="r7">    shadow_indices </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice(tot_num, </span><span class="r12">int</span>  
 <span class="r4">  176 </span>│       │       │       │       │       │       │              │       │<span class="r7">    target_indices </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice(tot_num, </span><span class="r12">int</span>  
 <span class="r4">  177 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r12">print</span><span class="r7"> (</span><span class="r11">&quot;Data indices owned by the defender:&quot;</span><span class="r7">,s</span>  
 <span class="r4">  178 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  179 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># args.task = &#x27;mnist&#x27;</span><span class="r9">                         </span>  
 <span class="r4">  180 </span>│       │       │       │       │       │       │              │       │<span class="r7">    SAVE_PREFIX </span><span class="r10">=</span><span class="r7"> args</span><span class="r10">.</span><span class="r7">save_dir</span><span class="r10">+</span><span class="r11">&#x27;/shadow_model_ckp</span>  
 <span class="r4">  181 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> </span><span class="r14">not</span><span class="r7"> os</span><span class="r10">.</span><span class="r7">path</span><span class="r10">.</span><span class="r7">isdir(SAVE_PREFIX):</span><span class="r9">            </span>  
 <span class="r4">  182 </span>│       │       │       │       │       │       │              │       │<span class="r7">        os</span><span class="r10">.</span><span class="r7">mkdir(SAVE_PREFIX)</span><span class="r9">                     </span>  
 <span class="r4">  183 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> </span><span class="r14">not</span><span class="r7"> os</span><span class="r10">.</span><span class="r7">path</span><span class="r10">.</span><span class="r7">isdir(SAVE_PREFIX</span><span class="r10">+</span><span class="r11">&#x27;/models&#x27;</span><span class="r10">+</span><span class="r7">arg</span>  
 <span class="r4">  184 </span>│       │       │       │       │       │       │              │       │<span class="r7">        os</span><span class="r10">.</span><span class="r7">mkdir(SAVE_PREFIX</span><span class="r10">+</span><span class="r11">&#x27;/models&#x27;</span><span class="r10">+</span><span class="r7">args</span><span class="r10">.</span><span class="r7">model)</span>  
 <span class="r4">  185 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  186 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_shadow_acc </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  187 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_shadow_acc_mal </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                       </span>  
 <span class="r4">  188 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  189 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  190 </span>│       │       │       │       │       │       │              │       │<span class="r7">    base_model </span><span class="r10">=</span><span class="r7"> get_base_model()</span><span class="r9">                 </span>  
 <span class="r4">  191 </span>│       │       │       │       │       │       │              │       │<span class="r7">    atk_setting </span><span class="r10">=</span><span class="r7"> random_troj_setting(</span><span class="r11">&#x27;jumbo&#x27;</span><span class="r7">)</span><span class="r9">    </span>  
 <span class="r4">  192 </span>│       │       │       │       │       │       │              │       │<span class="r7">    trainset_mal </span><span class="r10">=</span><span class="r7"> MyBackdoorDataset(trainset, atk</span>  
 <span class="r4">  193 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># trainloader = torch.utils.data.DataLoader(tr</span>  
 <span class="r4">  194 </span>│       │       │       │       │       │       │              │       │<span class="r7">    trainloader </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">utils</span><span class="r10">.</span><span class="r7">data</span><span class="r10">.</span><span class="r7">DataLoader(trai</span>  
 <span class="r4">  195 </span>│       │       │       │       │       │       │              │       │<span class="r7">    testset_mal </span><span class="r10">=</span><span class="r7"> MyBackdoorDataset(testset, atk_s</span>  
 <span class="r4">  196 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># testloader_benign = torch.utils.data.DataLoa</span>  
 <span class="r4">  197 </span>│       │       │       │       │       │       │              │       │<span class="r7">    testloader_benign </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">utils</span><span class="r10">.</span><span class="r7">data</span><span class="r10">.</span><span class="r7">DataLoade</span>  
 <span class="r4">  198 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># testloader_mal = torch.utils.data.DataLoader</span>  
 <span class="r4">  199 </span>│       │       │       │       │       │       │              │       │<span class="r7">    testloader_mal </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">utils</span><span class="r10">.</span><span class="r7">data</span><span class="r10">.</span><span class="r7">DataLoader(t</span>  
 <span class="r4">  200 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  201 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  202 </span>│       │       │       │       │       │       │              │       │<span class="r7">    device </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">device(</span><span class="r11">&quot;cuda&quot;</span><span class="r7"> </span><span class="r6">if</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">cuda</span><span class="r10">.</span><span class="r7">is_</span>  
 <span class="r4">  203 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  204 </span>│       │       │       │       │       │       │              │       │<span class="r7">    in_size </span><span class="r10">=</span><span class="r7"> </span><span class="r10">28*28</span><span class="r9">                               </span>  
 <span class="r4">  205 </span>│       │       │       │       │       │       │              │       │<span class="r7">    out_size </span><span class="r10">=</span><span class="r7"> </span><span class="r10">2</span><span class="r9">                                  </span>  
 <span class="r4">  206 </span>│       │       │       │       │       │       │              │       │<span class="r7">    hidden_dim </span><span class="r10">=</span><span class="r7"> </span><span class="r10">16</span><span class="r9">                               </span>  
 <span class="r4">  207 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model </span><span class="r10">=</span><span class="r7"> GIN(in_size, hidden_dim, out_size)</span><span class="r10">.</span><span class="r7">to(</span>  
 <span class="r4">  208 </span>│       │       │       │       │       │       │              │       │<span class="r7">    train_2class_classification_model(model, base_</span>  
 <span class="r4">  209 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  210 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  211 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     train_model(model, trainloader, epoch_nu</span>  
 <span class="r4">  212 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># save_path = SAVE_PREFIX+&#x27;/models&#x27;+args.model</span>  
 <span class="r4">  213 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># torch.save(model.state_dict(), save_path)</span><span class="r9">   </span>  
 <span class="r4">  214 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     acc = eval_model(model, testloader_benig</span>  
 <span class="r4">  215 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     acc_mal = eval_model(model, testloader_m</span>  
 <span class="r4">  216 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     print (&quot;Acc %.4f, Acc on backdoor %.4f, </span>  
 <span class="r4">  217 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     p_size, pattern, loc, alpha, target_y, i</span>  
 <span class="r4">  218 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     print (&quot;\tp size: %d; loc: %s; alpha: %.</span>  
 <span class="r4">  219 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     all_shadow_acc.append(acc)</span><span class="r9">              </span>  
 <span class="r4">  220 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     all_shadow_acc_mal.append(acc_mal)</span><span class="r9">      </span>  
 <span class="r4">  221 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  222 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># log = {&#x27;shadow_num&#x27;:SHADOW_NUM,</span><span class="r9">             </span>  
 <span class="r4">  223 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#        &#x27;shadow_acc&#x27;:sum(all_shadow_acc)/len(</span>  
 <span class="r4">  224 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#        &#x27;shadow_acc_mal&#x27;:sum(all_shadow_acc_m</span>  
 <span class="r4">  225 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># log_path = SAVE_PREFIX+&#x27;/jumbo_%s.log&#x27;%args.</span>  
 <span class="r4">  226 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># with open(log_path, &quot;w&quot;) as outf:</span><span class="r9">           </span>  
 <span class="r4">  227 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15">#     json.dump(log, outf)</span><span class="r9">                    </span>  
 <span class="r4">  228 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># print (&quot;Log file saved to %s&quot;%log_path)</span><span class="r9">     </span>  
       ╵       ╵       ╵       ╵       ╵       ╵       ╵              ╵       ╵                                                    
Top net memory consumption, by line:
<span class="r2">(</span><span class="r17">1</span><span class="r2">)</span>     <span class="r17">1</span>:   <span class="r17">142</span> MB
<span class="r2">(</span><span class="r17">2</span><span class="r2">)</span>     <span class="r17">5</span>:     <span class="r17">6</span> MB
<span class="r18">             /home/yhy/Meta-Nerual-Trojan-Detection/model_lib/mnist_cnn_model.py: % of time =  24.37% out of   5.84s.              </span>
       ╷       ╷       ╷       ╷       ╷       ╷       ╷              ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r2">Time   </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">Memory </span>│<span class="r2">–––––– </span>│<span class="r2">–––––––––––   </span>│<span class="r2">Copy   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> Line </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">native</span><span class="r2"> </span>│<span class="r3">system</span><span class="r2"> </span>│<span class="r3">GPU</span><span class="r2">    </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">net</span><span class="r2">    </span>│<span class="r3">timeline</span><span class="r2">/%    </span>│<span class="r3">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/yhy/Meta-Nerual-Trojan-Detection/model_lib/… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r4">    1 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">numpy</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">np</span><span class="r9">                                </span>  
 <span class="r4">    2 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch</span><span class="r9">                                      </span>  
 <span class="r4">    3 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch.nn</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">nn</span><span class="r9">                             </span>  
 <span class="r4">    4 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch.nn.functional</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">F</span><span class="r9">                   </span>  
 <span class="r4">    5 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">    6 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model0</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">    7 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">    8 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model0, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">    9 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">   10 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model0&#x27;</span><span class="r9">                      </span>  
 <span class="r4">   11 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   12 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">16</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">   13 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">16</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">   14 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">   15 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">32*4*4</span><span class="r7">, </span><span class="r10">512</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">   16 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">512</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">   17 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   18 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">   19 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">   20 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   21 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">   22 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">   23 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">   24 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">   25 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   26 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x)))</span><span class="r9">  </span>  
 <span class="r4">   27 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))</span><span class="r9">  </span>  
 <span class="r4">   28 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc(x</span><span class="r10">.</span><span class="r7">view(B,</span><span class="r10">32*4*4</span><span class="r7">)))</span><span class="r9">     </span>  
 <span class="r4">   29 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">   30 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   31 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">   32 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   33 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">   34 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">   35 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">   36 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">   37 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   38 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model1</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">   39 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">   40 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model1, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">   41 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">   42 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model1&#x27;</span><span class="r9">                      </span>  
 <span class="r4">   43 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   44 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">16</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">   45 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">16</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">   46 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">   47 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool_1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span>  
 <span class="r4">   48 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool_2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span>  
 <span class="r4">   49 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">32*4*4</span><span class="r7">, </span><span class="r10">512</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">   50 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">512</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">   51 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   52 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">   53 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">   54 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   55 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">   56 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">   57 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">   58 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">   59 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   60 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool_1(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x)))</span>  
 <span class="r4">   61 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool_2(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))</span>  
 <span class="r4">   62 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool_2(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x)))</span>  
 <span class="r4">   63 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc(x</span><span class="r10">.</span><span class="r7">view(B,</span><span class="r10">32*4*4</span><span class="r7">)))</span><span class="r9">     </span>  
 <span class="r4">   64 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">   65 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   66 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">   67 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   68 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">   69 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">   70 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">   71 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">   72 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   73 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">random_troj_setting</span><span class="r7">(troj_type):</span><span class="r9">               </span>  
 <span class="r4">   74 </span>│       │       │       │       │       │       │              │       │<span class="r7">    MAX_SIZE </span><span class="r10">=</span><span class="r7"> </span><span class="r10">28</span><span class="r9">                                 </span>  
 <span class="r4">   75 </span>│       │       │       │       │       │       │              │       │<span class="r7">    CLASS_NUM </span><span class="r10">=</span><span class="r7"> </span><span class="r10">10</span><span class="r9">                                </span>  
 <span class="r4">   76 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   77 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> troj_type </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;jumbo&#x27;</span><span class="r7">:</span><span class="r9">                      </span>  
 <span class="r4">   78 </span>│       │       │       │       │       │       │              │       │<span class="r7">        p_size </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice([</span><span class="r10">2</span><span class="r7">,</span><span class="r10">3</span><span class="r7">,</span><span class="r10">4</span><span class="r7">,</span><span class="r10">5</span><span class="r7">,MAX_SIZ</span>  
 <span class="r4">   79 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> p_size </span><span class="r10">&lt;</span><span class="r7"> MAX_SIZE:</span><span class="r9">                     </span>  
 <span class="r4">   80 </span>│       │       │       │       │       │       │              │       │<span class="r7">            alpha </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">uniform(</span><span class="r10">0.2</span><span class="r7">, </span><span class="r10">0.6</span><span class="r7">)</span><span class="r9">   </span>  
 <span class="r4">   81 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> alpha </span><span class="r10">&gt;</span><span class="r7"> </span><span class="r10">0.5</span><span class="r7">:</span><span class="r9">                       </span>  
 <span class="r4">   82 </span>│       │       │       │       │       │       │              │       │<span class="r7">                alpha </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1.0</span><span class="r9">                       </span>  
 <span class="r4">   83 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   84 </span>│       │       │       │       │       │       │              │       │<span class="r7">            alpha </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">uniform(</span><span class="r10">0.05</span><span class="r7">, </span><span class="r10">0.2</span><span class="r7">)</span><span class="r9">  </span>  
 <span class="r4">   85 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">elif</span><span class="r7"> troj_type </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;M&#x27;</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">   86 </span>│       │       │       │       │       │       │              │       │<span class="r7">        p_size </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice([</span><span class="r10">2</span><span class="r7">,</span><span class="r10">3</span><span class="r7">,</span><span class="r10">4</span><span class="r7">,</span><span class="r10">5</span><span class="r7">], </span><span class="r10">1</span><span class="r7">)[</span><span class="r10">0</span><span class="r7">]</span>  
 <span class="r4">   87 </span>│       │       │       │       │       │       │              │       │<span class="r7">        alpha </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1.0</span><span class="r9">                               </span>  
 <span class="r4">   88 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">elif</span><span class="r7"> troj_type </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;B&#x27;</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">   89 </span>│       │       │       │       │       │       │              │       │<span class="r7">        p_size </span><span class="r10">=</span><span class="r7"> MAX_SIZE</span><span class="r9">                         </span>  
 <span class="r4">   90 </span>│       │       │       │       │       │       │              │       │<span class="r7">        alpha </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">uniform(</span><span class="r10">0.05</span><span class="r7">, </span><span class="r10">0.2</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">   91 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   92 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> p_size </span><span class="r10">&lt;</span><span class="r7"> MAX_SIZE:</span><span class="r9">                         </span>  
 <span class="r4">   93 </span>│       │       │       │       │       │       │              │       │<span class="r7">        loc_x </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">randint(MAX_SIZE</span><span class="r10">-</span><span class="r7">p_size)</span>  
 <span class="r4">   94 </span>│       │       │       │       │       │       │              │       │<span class="r7">        loc_y </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">randint(MAX_SIZE</span><span class="r10">-</span><span class="r7">p_size)</span>  
 <span class="r4">   95 </span>│       │       │       │       │       │       │              │       │<span class="r7">        loc </span><span class="r10">=</span><span class="r7"> (loc_x, loc_y)</span><span class="r9">                      </span>  
 <span class="r4">   96 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">   97 </span>│       │       │       │       │       │       │              │       │<span class="r7">        loc </span><span class="r10">=</span><span class="r7"> (</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">)</span><span class="r9">                              </span>  
 <span class="r4">   98 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   99 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pattern_num </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">randint(</span><span class="r10">1</span><span class="r7">, p_size</span><span class="r10">**2</span><span class="r7">)</span><span class="r9"> </span>  
 <span class="r4">  100 </span>│       │       │       │       │       │       │              │       │<span class="r7">    one_idx </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice(</span><span class="r12">list</span><span class="r7">(</span><span class="r12">range</span><span class="r7">(p_size</span><span class="r10">**</span>  
 <span class="r4">  101 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pattern_flat </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">zeros((p_size</span><span class="r10">**2</span><span class="r7">))</span><span class="r9">          </span>  
 <span class="r4">  102 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pattern_flat[one_idx] </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                     </span>  
 <span class="r4">  103 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pattern </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">reshape(pattern_flat, (p_size,p_s</span>  
 <span class="r4">  104 </span>│       │       │       │       │       │       │              │       │<span class="r7">    target_y </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">randint(CLASS_NUM)</span><span class="r9">       </span>  
 <span class="r4">  105 </span>│       │       │       │       │       │       │              │       │<span class="r7">    inject_p </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">uniform(</span><span class="r10">0.05</span><span class="r7">, </span><span class="r10">0.5</span><span class="r7">)</span><span class="r9">       </span>  
 <span class="r4">  106 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  107 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> p_size, pattern, loc, alpha, target_y, </span>  
 <span class="r4">  108 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  109 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">troj_gen_func</span><span class="r7">(X, y, atk_setting):</span><span class="r9">             </span>  
 <span class="r4">  110 </span>│       │       │       │       │       │       │              │       │<span class="r7">    p_size, pattern, loc, alpha, target_y, inject_</span>  
 <span class="r4">  111 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  112 </span>│       │       │       │       │       │       │              │       │<span class="r7">    w, h </span><span class="r10">=</span><span class="r7"> loc</span><span class="r9">                                    </span>  
 <span class="r4">  113 </span>│       │       │       │       │       │       │              │       │<span class="r7">    X_new </span><span class="r10">=</span><span class="r7"> X</span><span class="r10">.</span><span class="r7">clone()</span><span class="r9">                             </span>  
 <span class="r4">  114 </span>│       │       │       │       │       │       │              │       │<span class="r7">    X_new[</span><span class="r10">0</span><span class="r7">, w:w</span><span class="r10">+</span><span class="r7">p_size, h:h</span><span class="r10">+</span><span class="r7">p_size] </span><span class="r10">=</span><span class="r7"> alpha </span><span class="r10">*</span><span class="r7"> tor</span>  
 <span class="r4">  115 </span>│       │       │       │       │       │       │              │       │<span class="r7">    y_new </span><span class="r10">=</span><span class="r7"> target_y</span><span class="r9">                              </span>  
 <span class="r4">  116 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> X_new, y_new</span><span class="r9">                           </span>  
 <span class="r4">  117 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  118 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model2</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  119 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">  120 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model2, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">  121 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">  122 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model2&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  123 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  124 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  125 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">  126 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">64</span><span class="r7">, kernel_size</span>  
 <span class="r4">  127 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">  128 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">64</span><span class="r7">, </span><span class="r10">256</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  129 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">256</span><span class="r7">, </span><span class="r10">120</span><span class="r7">)</span><span class="r9">            </span>  
 <span class="r4">  130 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">120</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">  131 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  132 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">  133 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">  134 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  135 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">  136 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  137 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">  138 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  139 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  140 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x))</span><span class="r9">                 </span>  
 <span class="r4">  141 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))  </span>  
 <span class="r4">  142 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x)))</span><span class="r9">  </span>  
 <span class="r4">  143 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">dropout(x, p</span><span class="r10">=0.5</span><span class="r7">, training</span><span class="r10">=</span><span class="r12">self</span><span class="r10">.</span><span class="r7">trai</span>  
 <span class="r4">  144 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">view(B, </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">64</span><span class="r7">)</span><span class="r9">                 </span>  
 <span class="r4">  145 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc(x))</span><span class="r9">                    </span>  
 <span class="r4">  146 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">dropout(x, training</span><span class="r10">=</span><span class="r12">self</span><span class="r10">.</span><span class="r7">training)</span><span class="r9">  </span>  
 <span class="r4">  147 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1(x)</span><span class="r9">                           </span>  
 <span class="r4">  148 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">  149 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  150 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">  151 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  152 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">  153 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  154 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">  155 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">  156 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  157 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model3</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  158 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">  159 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model3, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">  160 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">  161 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model3&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  162 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  163 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">64</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  164 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">64</span><span class="r7">, </span><span class="r10">128</span><span class="r7">, kernel_siz</span>  
 <span class="r4">  165 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">128</span><span class="r7">, </span><span class="r10">16</span><span class="r7">, kernel_siz</span>  
 <span class="r4">  166 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">  167 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">16</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">3</span><span class="r7">, </span><span class="r10">120</span><span class="r7">)</span><span class="r9">     </span>  
 <span class="r4">  168 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">120</span><span class="r7">, </span><span class="r10">84</span><span class="r7">)</span><span class="r9">             </span>  
 <span class="r4">  169 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">84</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">           </span>  
 <span class="r4">  170 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  171 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">  172 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">  173 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  174 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">  175 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  176 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">  177 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  178 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  179 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x)))</span><span class="r9">  </span>  
 <span class="r4">  180 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))</span><span class="r9">  </span>  
 <span class="r4">  181 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">dropout(x, p</span><span class="r10">=0.5</span><span class="r7">, training</span><span class="r10">=</span><span class="r12">self</span><span class="r10">.</span><span class="r7">trai</span>  
 <span class="r4">  182 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x))</span><span class="r9">                 </span>  
 <span class="r4">  183 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1(x</span><span class="r10">.</span><span class="r7">view(B, </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">3</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">16</span><span class="r7">))</span>  
 <span class="r4">  184 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2(x))</span><span class="r9">                   </span>  
 <span class="r4">  185 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">  186 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  187 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">  188 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  189 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">  190 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  191 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">  192 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">  193 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  194 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  195 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model4</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  196 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">  197 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model4, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">  198 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">  199 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model4&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  200 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  201 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  202 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">64</span><span class="r7">, kernel_size</span>  
 <span class="r4">  203 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">64</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">  204 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">  205 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">  206 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">32</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">2</span><span class="r7">, </span><span class="r10">512</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  207 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">512</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">  208 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  209 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">  210 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">  211 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  212 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">  213 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  214 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">  215 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  216 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  217 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x)))</span><span class="r9">  </span>  
 <span class="r4">  218 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x))</span><span class="r9">                 </span>  
 <span class="r4">  219 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x))</span><span class="r9">                 </span>  
 <span class="r4">  220 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4(x)))</span><span class="r9">  </span>  
 <span class="r4">  221 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc(x</span><span class="r10">.</span><span class="r7">view(</span><span class="r10">-1</span><span class="r7">, </span><span class="r10">32</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">2</span><span class="r7">))</span>  
 <span class="r4">  222 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">dropout(x, p</span><span class="r10">=0.5</span><span class="r7">, training</span><span class="r10">=</span><span class="r12">self</span><span class="r10">.</span><span class="r7">trai</span>  
 <span class="r4">  223 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">  224 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  225 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">  226 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  227 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">  228 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  229 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">  230 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">  231 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  232 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  233 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model5</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  234 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">  235 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model5, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">  236 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">  237 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model4&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  238 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  239 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  240 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">  241 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">16</span><span class="r7">, kernel_size</span>  
 <span class="r4">  242 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">16</span><span class="r7">, </span><span class="r10">8</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  243 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">  244 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">8</span><span class="r7">, </span><span class="r10">512</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  245 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">512</span><span class="r7">, </span><span class="r10">128</span><span class="r7">)</span><span class="r9">            </span>  
 <span class="r4">  246 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">128</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">  247 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  248 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">  249 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">  250 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  251 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">  252 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  253 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">  254 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  255 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  256 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x))</span><span class="r9">                 </span>  
 <span class="r4">  257 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))</span><span class="r9">  </span>  
 <span class="r4">  258 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x))</span><span class="r9">                 </span>  
 <span class="r4">  259 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4(x)))</span><span class="r9">  </span>  
 <span class="r4">  260 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1(x</span><span class="r10">.</span><span class="r7">view(B, </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">8</span><span class="r7">)))</span>  
 <span class="r4">  261 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2(x))</span><span class="r9">                   </span>  
 <span class="r4">  262 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">  263 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  264 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x</span><span class="r9">                                  </span>  
 <span class="r4">  265 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  266 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">  267 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  268 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">  269 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">  270 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  271 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  272 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">Model6</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  273 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, gpu</span><span class="r10">=</span><span class="r6">False</span><span class="r7">):</span><span class="r9">                </span>  
 <span class="r4">  274 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">(Model6, </span><span class="r12">self</span><span class="r7">)</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">            </span>  
 <span class="r4">  275 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu </span><span class="r10">=</span><span class="r7"> gpu</span><span class="r9">                            </span>  
 <span class="r4">  276 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">name </span><span class="r10">=</span><span class="r7"> </span><span class="r11">&#x27;Model6&#x27;</span><span class="r9">                      </span>  
 <span class="r4">  277 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  278 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">1</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  279 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">32</span><span class="r7">, kernel_size</span>  
 <span class="r4">  280 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">32</span><span class="r7">, </span><span class="r10">16</span><span class="r7">, kernel_size</span>  
 <span class="r4">  281 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Conv2d(</span><span class="r10">16</span><span class="r7">, </span><span class="r10">8</span><span class="r7">, kernel_size</span><span class="r10">=</span>  
 <span class="r4">  282 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">MaxPool2d(kernel_size</span><span class="r10">=2</span>  
 <span class="r4">  283 </span>│       │       │       │       │       │    2M │▁             │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">8</span><span class="r7">, </span><span class="r10">512</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  284 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2 </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">512</span><span class="r7">, </span><span class="r10">128</span><span class="r7">)</span><span class="r9">            </span>  
 <span class="r4">  285 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Linear(</span><span class="r10">128</span><span class="r7">, </span><span class="r10">10</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">  286 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  287 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> gpu:</span><span class="r9">                                   </span>  
 <span class="r4">  288 </span>│       │   22% │   2%  │  7%   │  56%  │ 1.55G │▇▇████▇  88%  │   337 │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                           </span>  
 <span class="r4">  289 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  290 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">  291 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  292 </span>│       │       │       │       │       │       │              │       │<span class="r7">            x </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                          </span>  
 <span class="r4">  293 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  294 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params </span><span class="r10">=</span><span class="r7"> {}</span><span class="r9">                               </span>  
 <span class="r4">  295 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv1(x))</span><span class="r9">                 </span>  
 <span class="r4">  296 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;conv1&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">              </span>  
 <span class="r4">  297 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv2(x)))</span><span class="r9">  </span>  
 <span class="r4">  298 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;conv2&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">              </span>  
 <span class="r4">  299 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv3(x))</span><span class="r9">                 </span>  
 <span class="r4">  300 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;conv3&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">              </span>  
 <span class="r4">  301 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">max_pool(F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">conv4(x)))</span><span class="r9">  </span>  
 <span class="r4">  302 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;conv4&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">              </span>  
 <span class="r4">  303 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc1(x</span><span class="r10">.</span><span class="r7">view(B, </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">7</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> </span><span class="r10">8</span><span class="r7">)))</span>  
 <span class="r4">  304 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;fc1&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">                </span>  
 <span class="r4">  305 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">fc2(x))</span><span class="r9">                   </span>  
 <span class="r4">  306 </span>│       │       │       │       │       │       │              │       │<span class="r7">        params[</span><span class="r11">&#x27;fc2&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> x</span><span class="r10">.</span><span class="r7">tolist()</span><span class="r9">                </span>  
 <span class="r4">  307 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">output(x)</span><span class="r9">                        </span>  
 <span class="r4">  308 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  309 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> x, params</span><span class="r9">                          </span>  
 <span class="r4">  310 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  311 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">loss</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, pred, label):</span><span class="r9">                  </span>  
 <span class="r4">  312 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gpu:</span><span class="r9">                              </span>  
 <span class="r4">  313 </span>│       │       │       │       │       │       │              │       │<span class="r7">            label </span><span class="r10">=</span><span class="r7"> label</span><span class="r10">.</span><span class="r7">cuda()</span><span class="r9">                  </span>  
 <span class="r4">  314 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">cross_entropy(pred, label)</span><span class="r9">       </span>  
 <span class="r4">      </span>│       │       │       │       │       │       │              │       │                                                    
╶──────┼───────┼───────┼───────┼───────┼───────┼───────┼──────────────┼───────┼───────────────────────────────────────────────────╴
 <span class="r4">      </span>│       │       │       │       │       │       │              │       │<span class="r3">function summary for /home/yhy/Meta-Nerual-Trojan…</span>  
 <span class="r4">  273 </span>│       │   20% │   4%  │  7%   │  56%  │ 1.55G │███████  88%  │   337 │<span class="r7">Model6</span><span class="r10">.</span><span class="r13">__init__</span><span class="r9">                                   </span>  
       ╵       ╵       ╵       ╵       ╵       ╵       ╵              ╵       ╵                                                    
Top net memory consumption, by line:
<span class="r2">(</span><span class="r17">1</span><span class="r2">)</span>   <span class="r17">288</span>:  <span class="r17">1585</span> MB
<span class="r2">(</span><span class="r17">2</span><span class="r2">)</span>   <span class="r17">283</span>:     <span class="r17">2</span> MB
<span class="r18">                    /home/yhy/Meta-Nerual-Trojan-Detection/utils_basic.py: % of time =   4.84% out of   5.84s.                     </span>
       ╷       ╷       ╷       ╷       ╷       ╷       ╷              ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r2">Time   </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">Memory </span>│<span class="r2">–––––– </span>│<span class="r2">–––––––––––   </span>│<span class="r2">Copy   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> Line </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">native</span><span class="r2"> </span>│<span class="r3">system</span><span class="r2"> </span>│<span class="r3">GPU</span><span class="r2">    </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">net</span><span class="r2">    </span>│<span class="r3">timeline</span><span class="r2">/%    </span>│<span class="r3">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/yhy/Meta-Nerual-Trojan-Detection/utils_basi… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r4">    1 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">numpy</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">np</span><span class="r9">                                </span>  
 <span class="r4">    2 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch</span><span class="r9">                                      </span>  
 <span class="r4">    3 </span>│    4% │       │       │ 17%   │       │   15M │▁▁▁▁▁▁        │     5 │<span class="r6">from</span><span class="r7"> </span><span class="r8">sklearn.metrics</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> roc_auc_score</span><span class="r9">         </span>  
 <span class="r4">    4 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torchvision</span><span class="r9">                                </span>  
 <span class="r4">    5 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torchvision.transforms</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">transforms</span><span class="r9">       </span>  
 <span class="r4">    6 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">importlib</span><span class="r9">                                  </span>  
 <span class="r4">    7 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">    8 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">load_spec_model</span><span class="r7">(module, model_index):</span><span class="r9">         </span>  
 <span class="r4">    9 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model </span><span class="r10">=</span><span class="r7"> </span><span class="r12">getattr</span><span class="r7">(module, </span><span class="r11">&#x27;Model&#x27;</span><span class="r10">+</span><span class="r7">model_index)</span><span class="r9">  </span>  
 <span class="r4">   10 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> model</span><span class="r9">                                  </span>  
 <span class="r4">   11 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   12 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   13 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">load_dataset_setting</span><span class="r7">(task, model):</span><span class="r9">            </span>  
 <span class="r4">   14 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> task </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;mnist&#x27;</span><span class="r7">:</span><span class="r9">                           </span>  
 <span class="r4">   15 </span>│       │       │       │       │       │       │              │       │<span class="r7">        BATCH_SIZE </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                          </span>  
 <span class="r4">   16 </span>│       │       │       │       │       │       │              │       │<span class="r7">        N_EPOCH </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                             </span>  
 <span class="r4">   17 </span>│       │       │       │       │       │       │              │       │<span class="r7">        transform </span><span class="r10">=</span><span class="r7"> transforms</span><span class="r10">.</span><span class="r7">Compose([</span><span class="r9">          </span>  
 <span class="r4">   18 </span>│       │       │       │       │       │       │              │       │<span class="r7">            transforms</span><span class="r10">.</span><span class="r7">ToTensor(),</span><span class="r9">                </span>  
 <span class="r4">   19 </span>│       │       │       │       │       │       │              │       │<span class="r7">        ])</span><span class="r9">                                        </span>  
 <span class="r4">   20 </span>│       │       │       │       │       │   45M │▁▁   2%       │       │<span class="r7">        trainset </span><span class="r10">=</span><span class="r7"> torchvision</span><span class="r10">.</span><span class="r7">datasets</span><span class="r10">.</span><span class="r7">MNIST(root</span>  
 <span class="r4">   21 </span>│       │       │       │       │       │    8M │▁             │       │<span class="r7">        testset </span><span class="r10">=</span><span class="r7"> torchvision</span><span class="r10">.</span><span class="r7">datasets</span><span class="r10">.</span><span class="r7">MNIST(root</span><span class="r10">=</span>  
 <span class="r4">   22 </span>│       │       │       │       │       │       │              │       │<span class="r7">        is_binary </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                         </span>  
 <span class="r4">   23 </span>│       │       │       │       │       │       │              │       │<span class="r7">        need_pad </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                          </span>  
 <span class="r4">   24 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   25 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># import module</span><span class="r9">                           </span>  
 <span class="r4">   26 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> mnist_cnn_model</span><span class="r9">     </span>  
 <span class="r4">   27 </span>│       │       │       │       │       │       │              │       │<span class="r7">        Model </span><span class="r10">=</span><span class="r7"> load_spec_model(mnist_cnn_model, m</span>  
 <span class="r4">   28 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">print</span><span class="r7">(</span><span class="r11">&quot;load </span><span class="r19">%s</span><span class="r11"> mnist cnn classification mo</span>  
 <span class="r4">   29 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.mnist_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> troj</span>  
 <span class="r4">   30 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">elif</span><span class="r7"> task </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;cifar10&#x27;</span><span class="r7">:</span><span class="r9">                       </span>  
 <span class="r4">   31 </span>│       │       │       │       │       │       │              │       │<span class="r7">        BATCH_SIZE </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                          </span>  
 <span class="r4">   32 </span>│       │       │       │       │       │       │              │       │<span class="r7">        N_EPOCH </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                             </span>  
 <span class="r4">   33 </span>│       │       │       │       │       │       │              │       │<span class="r7">        transform </span><span class="r10">=</span><span class="r7"> transforms</span><span class="r10">.</span><span class="r7">Compose([</span><span class="r9">          </span>  
 <span class="r4">   34 </span>│       │       │       │       │       │       │              │       │<span class="r7">            transforms</span><span class="r10">.</span><span class="r7">ToTensor(),</span><span class="r9">                </span>  
 <span class="r4">   35 </span>│       │       │       │       │       │       │              │       │<span class="r7">        ])</span><span class="r9">                                        </span>  
 <span class="r4">   36 </span>│       │       │       │       │       │       │              │       │<span class="r7">        trainset </span><span class="r10">=</span><span class="r7"> torchvision</span><span class="r10">.</span><span class="r7">datasets</span><span class="r10">.</span><span class="r7">CIFAR10(ro</span>  
 <span class="r4">   37 </span>│       │       │       │       │       │       │              │       │<span class="r7">        testset </span><span class="r10">=</span><span class="r7"> torchvision</span><span class="r10">.</span><span class="r7">datasets</span><span class="r10">.</span><span class="r7">CIFAR10(roo</span>  
 <span class="r4">   38 </span>│       │       │       │       │       │       │              │       │<span class="r7">        is_binary </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                         </span>  
 <span class="r4">   39 </span>│       │       │       │       │       │       │              │       │<span class="r7">        need_pad </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                          </span>  
 <span class="r4">   40 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># import module</span><span class="r9">                           </span>  
 <span class="r4">   41 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> cifar10_cnn_model</span><span class="r9">   </span>  
 <span class="r4">   42 </span>│       │       │       │       │       │       │              │       │<span class="r7">        Model </span><span class="r10">=</span><span class="r7"> load_spec_model(cifar10_cnn_model,</span>  
 <span class="r4">   43 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.cifar10_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> tr</span>  
 <span class="r4">   44 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">elif</span><span class="r7"> task </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;audio&#x27;</span><span class="r7">:</span><span class="r9">                         </span>  
 <span class="r4">   45 </span>│       │       │       │       │       │       │              │       │<span class="r7">        BATCH_SIZE </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                          </span>  
 <span class="r4">   46 </span>│       │       │       │       │       │       │              │       │<span class="r7">        N_EPOCH </span><span class="r10">=</span><span class="r7"> </span><span class="r10">100</span><span class="r9">                             </span>  
 <span class="r4">   47 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.audio_dataset</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> Speech</span>  
 <span class="r4">   48 </span>│       │       │       │       │       │       │              │       │<span class="r7">        trainset </span><span class="r10">=</span><span class="r7"> SpeechCommand(split</span><span class="r10">=0</span><span class="r7">)</span><span class="r9">         </span>  
 <span class="r4">   49 </span>│       │       │       │       │       │       │              │       │<span class="r7">        testset </span><span class="r10">=</span><span class="r7"> SpeechCommand(split</span><span class="r10">=2</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">   50 </span>│       │       │       │       │       │       │              │       │<span class="r7">        is_binary </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                         </span>  
 <span class="r4">   51 </span>│       │       │       │       │       │       │              │       │<span class="r7">        need_pad </span><span class="r10">=</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                          </span>  
 <span class="r4">   52 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.audio_rnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> Mode</span>  
 <span class="r4">   53 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">elif</span><span class="r7"> task </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;rtNLP&#x27;</span><span class="r7">:</span><span class="r9">                         </span>  
 <span class="r4">   54 </span>│       │       │       │       │       │       │              │       │<span class="r7">        BATCH_SIZE </span><span class="r10">=</span><span class="r7"> </span><span class="r10">64</span><span class="r9">                           </span>  
 <span class="r4">   55 </span>│       │       │       │       │       │       │              │       │<span class="r7">        N_EPOCH </span><span class="r10">=</span><span class="r7"> </span><span class="r10">50</span><span class="r9">                              </span>  
 <span class="r4">   56 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.rtNLP_dataset</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> RTNLP</span><span class="r9"> </span>  
 <span class="r4">   57 </span>│       │       │       │       │       │       │              │       │<span class="r7">        trainset </span><span class="r10">=</span><span class="r7"> RTNLP(train</span><span class="r10">=</span><span class="r6">True</span><span class="r7">)</span><span class="r9">              </span>  
 <span class="r4">   58 </span>│       │       │       │       │       │       │              │       │<span class="r7">        testset </span><span class="r10">=</span><span class="r7"> RTNLP(train</span><span class="r10">=</span><span class="r6">False</span><span class="r7">)</span><span class="r9">              </span>  
 <span class="r4">   59 </span>│       │       │       │       │       │       │              │       │<span class="r7">        is_binary </span><span class="r10">=</span><span class="r7"> </span><span class="r6">True</span><span class="r9">                          </span>  
 <span class="r4">   60 </span>│       │       │       │       │       │       │              │       │<span class="r7">        need_pad </span><span class="r10">=</span><span class="r7"> </span><span class="r6">True</span><span class="r9">                           </span>  
 <span class="r4">   61 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> model:</span><span class="r9">                                 </span>  
 <span class="r4">   62 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.rtNLP_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> </span>  
 <span class="r4">   63 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.rtNLP_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> </span>  
 <span class="r4">   64 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   65 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">from</span><span class="r7"> </span><span class="r8">model_lib.rtNLP_cnn_model</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> </span>  
 <span class="r4">   66 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">   67 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">raise</span><span class="r7"> </span><span class="r20">NotImplementedError</span><span class="r7">(</span><span class="r11">&quot;Unknown task </span><span class="r19">%s</span>  
 <span class="r4">   68 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   69 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   70 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> BATCH_SIZE, N_EPOCH, trainset, testset,</span>  
 <span class="r4">   71 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   72 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   73 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">BackdoorDataset</span><span class="r7">(torch</span><span class="r10">.</span><span class="r7">utils</span><span class="r10">.</span><span class="r7">data</span><span class="r10">.</span><span class="r7">Dataset):</span><span class="r9">  </span>  
 <span class="r4">   74 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, src_dataset, atk_setting, t</span>  
 <span class="r4">   75 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset </span><span class="r10">=</span><span class="r7"> src_dataset</span><span class="r9">            </span>  
 <span class="r4">   76 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">atk_setting </span><span class="r10">=</span><span class="r7"> atk_setting</span><span class="r9">            </span>  
 <span class="r4">   77 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">troj_gen_func </span><span class="r10">=</span><span class="r7"> troj_gen_func</span><span class="r9">        </span>  
 <span class="r4">   78 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">need_pad </span><span class="r10">=</span><span class="r7"> need_pad</span><span class="r9">                  </span>  
 <span class="r4">   79 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   80 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only </span><span class="r10">=</span><span class="r7"> mal_only</span><span class="r9">                  </span>  
 <span class="r4">   81 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> choice </span><span class="r14">is</span><span class="r7"> </span><span class="r6">None</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">   82 </span>│       │       │       │       │       │       │              │       │<span class="r7">            choice </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">arange(</span><span class="r12">len</span><span class="r7">(src_dataset))</span><span class="r9">  </span>  
 <span class="r4">   83 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">choice </span><span class="r10">=</span><span class="r7"> choice</span><span class="r9">                      </span>  
 <span class="r4">   84 </span>│       │       │       │       │       │       │              │       │<span class="r7">        inject_p </span><span class="r10">=</span><span class="r7"> atk_setting[</span><span class="r10">5</span><span class="r7">]</span><span class="r9">                 </span>  
 <span class="r4">   85 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choice </span><span class="r10">=</span><span class="r7"> np</span><span class="r10">.</span><span class="r7">random</span><span class="r10">.</span><span class="r7">choice(choice,</span>  
 <span class="r4">   86 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   87 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__len__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">,):</span><span class="r9">                           </span>  
 <span class="r4">   88 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only:</span><span class="r9">                         </span>  
 <span class="r4">   89 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">return</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choice)</span><span class="r9">           </span>  
 <span class="r4">   90 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   91 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">return</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">choice) </span><span class="r10">+</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal</span>  
 <span class="r4">   92 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   93 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__getitem__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, idx):</span><span class="r9">                   </span>  
 <span class="r4">   94 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> (</span><span class="r14">not</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only </span><span class="r14">and</span><span class="r7"> idx </span><span class="r10">&lt;</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">c</span>  
 <span class="r4">   95 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># Return non-trojaned data</span><span class="r9">            </span>  
 <span class="r4">   96 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">need_pad:</span><span class="r9">                     </span>  
 <span class="r4">   97 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># In NLP task we need to pad input</span>  
 <span class="r4">   98 </span>│       │       │       │       │       │       │              │       │<span class="r7">                p_size </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">atk_setting[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">      </span>  
 <span class="r4">   99 </span>│       │       │       │       │       │       │              │       │<span class="r7">                X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">choic</span>  
 <span class="r4">  100 </span>│       │       │       │       │       │       │              │       │<span class="r7">                X_padded </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">cat([X, torch</span><span class="r10">.</span><span class="r7">Lon</span>  
 <span class="r4">  101 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">return</span><span class="r7"> X_padded, y</span><span class="r9">                </span>  
 <span class="r4">  102 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  103 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">return</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">choic</span>  
 <span class="r4">  104 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  105 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_only:</span><span class="r9">                         </span>  
 <span class="r4">  106 </span>│       │       │       │       │       │       │              │       │<span class="r7">            X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choic</span>  
 <span class="r4">  107 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  108 </span>│       │       │       │       │       │       │              │       │<span class="r7">            X, y </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">src_dataset[</span><span class="r12">self</span><span class="r10">.</span><span class="r7">mal_choic</span>  
 <span class="r4">  109 </span>│       │       │       │       │       │       │              │       │<span class="r7">        X_new, y_new </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">troj_gen_func(X, y, </span><span class="r12">se</span>  
 <span class="r4">  110 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> X_new, y_new</span><span class="r9">                       </span>  
 <span class="r4">  111 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  112 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  113 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">train_model</span><span class="r7">(model, dataloader, epoch_num, is_b</span>  
 <span class="r4">  114 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">train()</span><span class="r9">                                 </span>  
 <span class="r4">  115 </span>│       │       │       │       │       │       │              │       │<span class="r7">    optimizer </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">optim</span><span class="r10">.</span><span class="r7">Adam(model</span><span class="r10">.</span><span class="r7">parameters(</span>  
 <span class="r4">  116 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  117 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> epoch </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(epoch_num):</span><span class="r9">                </span>  
 <span class="r4">  118 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cum_loss </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.0</span><span class="r9">                            </span>  
 <span class="r4">  119 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cum_acc </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.0</span><span class="r9">                             </span>  
 <span class="r4">  120 </span>│       │       │       │       │       │       │              │       │<span class="r7">        tot </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.0</span><span class="r9">                                 </span>  
 <span class="r4">  121 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i,(x_in, y_in) </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(dataloader</span>  
 <span class="r4">  122 </span>│       │       │       │       │       │       │              │       │<span class="r7">            B </span><span class="r10">=</span><span class="r7"> x_in</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                    </span>  
 <span class="r4">  123 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pred </span><span class="r10">=</span><span class="r7"> model(x_in)</span><span class="r9">                    </span>  
 <span class="r4">  124 </span>│       │       │       │       │       │       │              │       │<span class="r7">            loss </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">loss(pred, y_in)</span><span class="r9">         </span>  
 <span class="r4">  125 </span>│       │       │       │       │       │       │              │       │<span class="r7">            optimizer</span><span class="r10">.</span><span class="r7">zero_grad()</span><span class="r9">                 </span>  
 <span class="r4">  126 </span>│       │       │       │       │       │       │              │       │<span class="r7">            loss</span><span class="r10">.</span><span class="r7">backward()</span><span class="r9">                       </span>  
 <span class="r4">  127 </span>│       │       │       │       │       │       │              │       │<span class="r7">            optimizer</span><span class="r10">.</span><span class="r7">step()</span><span class="r9">                      </span>  
 <span class="r4">  128 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cum_loss </span><span class="r10">+=</span><span class="r7"> loss</span><span class="r10">.</span><span class="r7">item() </span><span class="r10">*</span><span class="r7"> B</span><span class="r9">           </span>  
 <span class="r4">  129 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> is_binary:</span><span class="r9">                         </span>  
 <span class="r4">  130 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cum_acc </span><span class="r10">+=</span><span class="r7"> ((pred</span><span class="r10">&gt;0</span><span class="r7">)</span><span class="r10">.</span><span class="r7">cpu()</span><span class="r10">.</span><span class="r7">long()</span><span class="r10">.</span>  
 <span class="r4">  131 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  132 </span>│       │       │       │       │       │       │              │       │<span class="r7">                pred_c </span><span class="r10">=</span><span class="r7"> pred</span><span class="r10">.</span><span class="r7">max(</span><span class="r10">1</span><span class="r7">)[</span><span class="r10">1</span><span class="r7">]</span><span class="r10">.</span><span class="r7">cpu()</span><span class="r9">     </span>  
 <span class="r4">  133 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cum_acc </span><span class="r10">+=</span><span class="r7"> (pred_c</span><span class="r10">.</span><span class="r7">eq(y_in))</span><span class="r10">.</span><span class="r7">sum()</span>  
 <span class="r4">  134 </span>│       │       │       │       │       │       │              │       │<span class="r7">            tot </span><span class="r10">=</span><span class="r7"> tot </span><span class="r10">+</span><span class="r7"> B</span><span class="r9">                         </span>  
 <span class="r4">  135 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> verbose:</span><span class="r9">                               </span>  
 <span class="r4">  136 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">print</span><span class="r7"> (</span><span class="r11">&quot;Epoch </span><span class="r19">%d</span><span class="r11">, loss = </span><span class="r19">%.4f</span><span class="r11">, acc = </span><span class="r19">%</span>  
 <span class="r4">  137 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r9">                                        </span>  
 <span class="r4">  138 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  139 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  140 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">eval_model</span><span class="r7">(model, dataloader, is_binary):</span><span class="r9">     </span>  
 <span class="r4">  141 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">eval()</span><span class="r9">                                  </span>  
 <span class="r4">  142 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cum_acc </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.0</span><span class="r9">                                 </span>  
 <span class="r4">  143 </span>│       │       │       │       │       │       │              │       │<span class="r7">    tot </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0.0</span><span class="r9">                                     </span>  
 <span class="r4">  144 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> i,(x_in, y_in) </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(dataloader):</span><span class="r9">  </span>  
 <span class="r4">  145 </span>│       │       │       │       │       │       │              │       │<span class="r7">        B </span><span class="r10">=</span><span class="r7"> x_in</span><span class="r10">.</span><span class="r7">size()[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                        </span>  
 <span class="r4">  146 </span>│       │       │       │       │       │       │              │       │<span class="r7">        pred </span><span class="r10">=</span><span class="r7"> model(x_in)</span><span class="r9">                        </span>  
 <span class="r4">  147 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> is_binary:</span><span class="r9">                             </span>  
 <span class="r4">  148 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cum_acc </span><span class="r10">+=</span><span class="r7"> ((pred</span><span class="r10">&gt;0</span><span class="r7">)</span><span class="r10">.</span><span class="r7">cpu()</span><span class="r10">.</span><span class="r7">long()</span><span class="r10">.</span><span class="r7">eq(y</span>  
 <span class="r4">  149 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  150 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pred_c </span><span class="r10">=</span><span class="r7"> pred</span><span class="r10">.</span><span class="r7">max(</span><span class="r10">1</span><span class="r7">)[</span><span class="r10">1</span><span class="r7">]</span><span class="r10">.</span><span class="r7">cpu()</span><span class="r9">         </span>  
 <span class="r4">  151 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cum_acc </span><span class="r10">+=</span><span class="r7"> (pred_c</span><span class="r10">.</span><span class="r7">eq(y_in))</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">ite</span>  
 <span class="r4">  152 </span>│       │       │       │       │       │       │              │       │<span class="r7">        tot </span><span class="r10">=</span><span class="r7"> tot </span><span class="r10">+</span><span class="r7"> B</span><span class="r9">                             </span>  
 <span class="r4">  153 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> cum_acc </span><span class="r10">/</span><span class="r7"> tot</span><span class="r9">                          </span>  
 <span class="r4">  154 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">      </span>│       │       │       │       │       │       │              │       │                                                    
╶──────┼───────┼───────┼───────┼───────┼───────┼───────┼──────────────┼───────┼───────────────────────────────────────────────────╴
 <span class="r4">      </span>│       │       │       │       │       │       │              │       │<span class="r3">function summary for /home/yhy/Meta-Nerual-Trojan…</span>  
 <span class="r4">   13 </span>│       │       │       │       │       │   53M │▂▂   3%       │       │<span class="r7">load_dataset_setting</span><span class="r9">                              </span>  
       ╵       ╵       ╵       ╵       ╵       ╵       ╵              ╵       ╵                                                    
Top net memory consumption, by line:
<span class="r2">(</span><span class="r17">1</span><span class="r2">)</span>    <span class="r17">20</span>:    <span class="r17">45</span> MB
<span class="r2">(</span><span class="r17">2</span><span class="r2">)</span>     <span class="r17">3</span>:    <span class="r17">15</span> MB
<span class="r2">(</span><span class="r17">3</span><span class="r2">)</span>    <span class="r17">21</span>:     <span class="r17">8</span> MB
<span class="r18">                     /home/yhy/Meta-Nerual-Trojan-Detection/utils_gnn.py: % of time =   0.10% out of   5.84s.                      </span>
       ╷       ╷       ╷       ╷       ╷       ╷       ╷              ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r2">Time   </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">–––––– </span>│<span class="r2">Memory </span>│<span class="r2">–––––– </span>│<span class="r2">–––––––––––   </span>│<span class="r2">Copy   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> Line </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">native</span><span class="r2"> </span>│<span class="r3">system</span><span class="r2"> </span>│<span class="r3">GPU</span><span class="r2">    </span>│<span class="r3">Python</span><span class="r2"> </span>│<span class="r3">net</span><span class="r2">    </span>│<span class="r3">timeline</span><span class="r2">/%    </span>│<span class="r3">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/yhy/Meta-Nerual-Trojan-Detection/utils_gnn.… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r4">    1 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">dgl</span><span class="r9">                                        </span>  
 <span class="r4">    2 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">dgl.data</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> DGLDataset</span><span class="r9">                   </span>  
 <span class="r4">    3 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">os</span><span class="r9">                                         </span>  
 <span class="r4">    4 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">tqdm</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> tqdm</span><span class="r9">                             </span>  
 <span class="r4">    5 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">dgl</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> save_graphs, load_graphs</span><span class="r9">          </span>  
 <span class="r4">    6 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch</span><span class="r9">                                      </span>  
 <span class="r4">    7 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">json</span><span class="r9">                                       </span>  
 <span class="r4">    8 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">torch</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> nn</span><span class="r9">                              </span>  
 <span class="r4">    9 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">numpy</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">np</span><span class="r9">                                </span>  
 <span class="r4">   10 </span>│       │       │       │       │       │       │              │       │<span class="r15"># from model_lib.mnist_cnn_model import Model</span><span class="r9">     </span>  
 <span class="r4">   11 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">random</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> randint</span><span class="r9">                        </span>  
 <span class="r4">   12 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">utils_basic</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> load_spec_model</span><span class="r9">           </span>  
 <span class="r4">   13 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">sklearn.metrics</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> roc_auc_score</span><span class="r9">         </span>  
 <span class="r4">   14 </span>│       │       │       │       │       │    1M │▁             │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">torchinfo</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> summary</span><span class="r9">                     </span>  
 <span class="r4">   15 </span>│       │       │       │       │       │       │              │       │<span class="r6">import</span><span class="r7"> </span><span class="r8">torch.nn.functional</span><span class="r7"> </span><span class="r6">as</span><span class="r7"> </span><span class="r8">F</span><span class="r9">                   </span>  
 <span class="r4">   16 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">dgl.nn.pytorch.conv</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> GINConv</span><span class="r9">           </span>  
 <span class="r4">   17 </span>│       │       │       │       │       │       │              │       │<span class="r6">from</span><span class="r7"> </span><span class="r8">dgl.nn.pytorch.glob</span><span class="r7"> </span><span class="r6">import</span><span class="r7"> SumPooling, AvgPoo</span>  
 <span class="r4">   18 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   19 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">MLP</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                             </span>  
 <span class="r4">   20 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r21">&quot;&quot;&quot;Construct two-layer MLP-type aggreator for </span>  
 <span class="r4">   21 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, input_dim, hidden_dim, outp</span>  
 <span class="r4">   22 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">()</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">                        </span>  
 <span class="r4">   23 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linears </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">            </span>  
 <span class="r4">   24 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># two-layer MLP    </span><span class="r9">                       </span>  
 <span class="r4">   25 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linears</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">Linear(input_dim, h</span>  
 <span class="r4">   26 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linears</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">Linear(hidden_dim, </span>  
 <span class="r4">   27 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norm </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">BatchNorm1d((hidden_d</span>  
 <span class="r4">   28 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   29 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, x):</span><span class="r9">                         </span>  
 <span class="r4">   30 </span>│       │       │       │       │       │       │              │       │<span class="r7">        h </span><span class="r10">=</span><span class="r7"> x</span><span class="r9">                                     </span>  
 <span class="r4">   31 </span>│       │       │       │       │       │       │              │       │<span class="r7">        h </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norm(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">linears[</span><span class="r10">0</span><span class="r7">]</span>  
 <span class="r4">   32 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linears[</span><span class="r10">1</span><span class="r7">](h)</span><span class="r9">                 </span>  
 <span class="r4">   33 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">   34 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">SGN</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                             </span>  
 <span class="r4">   35 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, input_dim, hidden_dim, outp</span>  
 <span class="r4">   36 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">()</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">                        </span>  
 <span class="r4">   37 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">assert</span><span class="r7"> pooling </span><span class="r14">in</span><span class="r7"> [</span><span class="r11">&#x27;sum&#x27;</span><span class="r7">, </span><span class="r11">&#x27;avg&#x27;</span><span class="r7">, </span><span class="r11">&#x27;max&#x27;</span><span class="r7">], </span><span class="r11">&quot;</span>  
 <span class="r4">   38 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">          </span>  
 <span class="r4">   39 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">        </span>  
 <span class="r4">   40 </span>│       │       │       │       │       │       │              │       │<span class="r7">        num_layers </span><span class="r10">=</span><span class="r7"> </span><span class="r10">2</span><span class="r9">                            </span>  
 <span class="r4">   41 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># five-layer GCN with two-layer MLP aggreg</span>  
 <span class="r4">   42 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         for layer in range(num_layers - 1): # ex</span>  
 <span class="r4">   43 </span>│       │       │       │       │       │       │              │       │<span class="r15">#             if layer == 0:</span><span class="r9">                      </span>  
 <span class="r4">   44 </span>│       │       │       │       │       │       │              │       │<span class="r15">#                 mlp = MLP(input_dim, hidden_dim,</span>  
 <span class="r4">   45 </span>│       │       │       │       │       │       │              │       │<span class="r15">#             else:</span><span class="r9">                               </span>  
 <span class="r4">   46 </span>│       │       │       │       │       │       │              │       │<span class="r15">#                 mlp = MLP(hidden_dim, hidden_dim</span>  
 <span class="r4">   47 </span>│       │       │       │       │       │       │              │       │<span class="r15">#             self.ginlayers.append(GINConv(mlp, l</span>  
 <span class="r4">   48 </span>│       │       │       │       │       │       │              │       │<span class="r15">#             self.batch_norms.append(nn.BatchNorm</span>  
 <span class="r4">   49 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># linear functions for graph sum poolings </span>  
 <span class="r4">   50 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">  </span>  
 <span class="r4">   51 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(num_layers):</span><span class="r9">           </span>  
 <span class="r4">   52 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> layer </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">   53 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">   54 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">   55 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">   56 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Dropout(</span><span class="r10">0.8</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">   57 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> pooling </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;sum&#x27;</span><span class="r7">:</span><span class="r9">                      </span>  
 <span class="r4">   58 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> SumPooling() </span><span class="r15"># change to m</span>  
 <span class="r4">   59 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">elif</span><span class="r7"> pooling </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;avg&#x27;</span><span class="r7">:</span><span class="r9">                    </span>  
 <span class="r4">   60 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> AvgPooling()</span><span class="r9">              </span>  
 <span class="r4">   61 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">   62 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> MaxPooling()</span><span class="r9">              </span>  
 <span class="r4">   63 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.topK = topK</span><span class="r9">                        </span>  
 <span class="r4">   64 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.pool = SortPooling(topK)</span><span class="r9">           </span>  
 <span class="r4">   65 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.pool = AvgPooling()</span><span class="r9">                </span>  
 <span class="r4">   66 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r9">                                          </span>  
 <span class="r4">   67 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, g, h):</span><span class="r9">                      </span>  
 <span class="r4">   68 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># list of hidden representation at each la</span>  
 <span class="r4">   69 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># img_class = cnn_foward()</span><span class="r9">                </span>  
 <span class="r4">   70 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># gnn_class = gnn_foward()</span><span class="r9">                </span>  
 <span class="r4">   71 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># return img_class, gnn_class </span><span class="r9">            </span>  
 <span class="r4">   72 </span>│       │       │       │       │       │       │              │       │<span class="r7">        hidden_rep </span><span class="r10">=</span><span class="r7"> [h]</span><span class="r9">                          </span>  
 <span class="r4">   73 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers):</span>  
 <span class="r4">   74 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> layer(g, h)</span><span class="r9">                       </span>  
 <span class="r4">   75 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms[i](h)</span><span class="r9">            </span>  
 <span class="r4">   76 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(h)</span><span class="r9">                         </span>  
 <span class="r4">   77 </span>│       │       │       │       │       │       │              │       │<span class="r7">            hidden_rep</span><span class="r10">.</span><span class="r7">append(h)</span><span class="r9">                  </span>  
 <span class="r4">   78 </span>│       │       │       │       │       │       │              │       │<span class="r7">        score_over_layer </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                      </span>  
 <span class="r4">   79 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># perform graph sum pooling over all nodes</span>  
 <span class="r4">   80 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, h </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(hidden_rep):</span><span class="r9">        </span>  
 <span class="r4">   81 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pooled_h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool(g, h)</span><span class="r9">            </span>  
 <span class="r4">   82 </span>│       │       │       │       │       │       │              │       │<span class="r7">            score_over_layer </span><span class="r10">+=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">lin</span>  
 <span class="r4">   83 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> score_over_layer</span><span class="r9">                   </span>  
 <span class="r4">   84 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">   85 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r9">                                          </span>  
 <span class="r4">   86 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">GIN</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                             </span>  
 <span class="r4">   87 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, input_dim, hidden_dim, outp</span>  
 <span class="r4">   88 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">()</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">                        </span>  
 <span class="r4">   89 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">          </span>  
 <span class="r4">   90 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">        </span>  
 <span class="r4">   91 </span>│       │       │       │       │       │       │              │       │<span class="r7">        num_layers </span><span class="r10">=</span><span class="r7"> </span><span class="r10">5</span><span class="r9">                            </span>  
 <span class="r4">   92 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># five-layer GCN with two-layer MLP aggreg</span>  
 <span class="r4">   93 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(num_layers </span><span class="r10">-</span><span class="r7"> </span><span class="r10">1</span><span class="r7">):  </span><span class="r15"># exc</span>  
 <span class="r4">   94 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> layer </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">   95 </span>│       │       │       │       │       │       │              │       │<span class="r7">                mlp </span><span class="r10">=</span><span class="r7"> MLP(input_dim, hidden_dim, h</span>  
 <span class="r4">   96 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">   97 </span>│       │       │       │       │       │       │              │       │<span class="r7">                mlp </span><span class="r10">=</span><span class="r7"> MLP(hidden_dim, hidden_dim, </span>  
 <span class="r4">   98 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers</span><span class="r10">.</span><span class="r7">append(</span><span class="r9">                </span>  
 <span class="r4">   99 </span>│       │       │       │       │       │       │              │       │<span class="r7">                GINConv(mlp, learn_eps</span><span class="r10">=</span><span class="r6">False</span><span class="r7">)</span><span class="r9">     </span>  
 <span class="r4">  100 </span>│       │       │       │       │       │       │              │       │<span class="r7">            )  </span><span class="r15"># set to True if learning epsilon</span><span class="r9">  </span>  
 <span class="r4">  101 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">BatchNorm1d</span>  
 <span class="r4">  102 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># linear functions for graph sum poolings </span>  
 <span class="r4">  103 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">  </span>  
 <span class="r4">  104 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(num_layers):</span><span class="r9">           </span>  
 <span class="r4">  105 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> layer </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  106 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">  107 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  108 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">  109 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Dropout(</span><span class="r10">0.5</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  110 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> (</span><span class="r9">                             </span>  
 <span class="r4">  111 </span>│       │       │       │       │       │       │              │       │<span class="r7">            SumPooling()</span><span class="r9">                          </span>  
 <span class="r4">  112 </span>│       │       │       │       │       │       │              │       │<span class="r7">        )  </span><span class="r15"># change to mean readout (AvgPooling) o</span>  
 <span class="r4">  113 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  114 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, g, h):</span><span class="r9">                      </span>  
 <span class="r4">  115 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># list of hidden representation at each la</span>  
 <span class="r4">  116 </span>│       │       │       │       │       │       │              │       │<span class="r7">        hidden_rep </span><span class="r10">=</span><span class="r7"> [h]</span><span class="r9">                          </span>  
 <span class="r4">  117 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers):</span>  
 <span class="r4">  118 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> layer(g, h)</span><span class="r9">                       </span>  
 <span class="r4">  119 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms[i](h)</span><span class="r9">            </span>  
 <span class="r4">  120 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(h)</span><span class="r9">                         </span>  
 <span class="r4">  121 </span>│       │       │       │       │       │       │              │       │<span class="r7">            hidden_rep</span><span class="r10">.</span><span class="r7">append(h)</span><span class="r9">                  </span>  
 <span class="r4">  122 </span>│       │       │       │       │       │       │              │       │<span class="r7">        score_over_layer </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                      </span>  
 <span class="r4">  123 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># perform graph sum pooling over all nodes</span>  
 <span class="r4">  124 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, h </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(hidden_rep):</span><span class="r9">        </span>  
 <span class="r4">  125 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pooled_h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool(g, h)</span><span class="r9">            </span>  
 <span class="r4">  126 </span>│       │       │       │       │       │       │              │       │<span class="r7">            score_over_layer </span><span class="r10">+=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">lin</span>  
 <span class="r4">  127 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> score_over_layer</span><span class="r9">                   </span>  
 <span class="r4">  128 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  129 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  130 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">split_fold10</span><span class="r7">(labels, fold_idx</span><span class="r10">=0</span><span class="r7">):</span><span class="r9">             </span>  
 <span class="r4">  131 </span>│       │       │       │       │       │       │              │       │<span class="r7">    skf </span><span class="r10">=</span><span class="r7"> StratifiedKFold(n_splits</span><span class="r10">=10</span><span class="r7">, shuffle</span><span class="r10">=</span><span class="r6">Tru</span>  
 <span class="r4">  132 </span>│       │       │       │       │       │       │              │       │<span class="r7">    idx_list </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                 </span>  
 <span class="r4">  133 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> idx </span><span class="r14">in</span><span class="r7"> skf</span><span class="r10">.</span><span class="r7">split(np</span><span class="r10">.</span><span class="r7">zeros(</span><span class="r12">len</span><span class="r7">(labels)), la</span>  
 <span class="r4">  134 </span>│       │       │       │       │       │       │              │       │<span class="r7">        idx_list</span><span class="r10">.</span><span class="r7">append(idx)</span><span class="r9">                      </span>  
 <span class="r4">  135 </span>│       │       │       │       │       │       │              │       │<span class="r7">    train_idx, valid_idx </span><span class="r10">=</span><span class="r7"> idx_list[fold_idx]</span><span class="r9">     </span>  
 <span class="r4">  136 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> train_idx, valid_idx</span><span class="r9">                   </span>  
 <span class="r4">  137 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  138 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">evaluate</span><span class="r7">(dataloader, device, model, threshold</span><span class="r10">=</span>  
 <span class="r4">  139 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">eval()</span><span class="r9">                                  </span>  
 <span class="r4">  140 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                     </span>  
 <span class="r4">  141 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_correct </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                             </span>  
 <span class="r4">  142 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_tp </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  143 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_fp </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  144 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_tn </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  145 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_fn </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  146 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> batch, (batched_graph, labels) </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerat</span>  
 <span class="r4">  147 </span>│       │       │       │       │       │       │              │       │<span class="r7">        batched_graph </span><span class="r10">=</span><span class="r7"> batched_graph</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">  </span>  
 <span class="r4">  148 </span>│       │       │       │       │       │       │              │       │<span class="r7">        labels </span><span class="r10">=</span><span class="r7"> labels</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">                </span>  
 <span class="r4">  149 </span>│       │       │       │       │       │       │              │       │<span class="r7">        feat </span><span class="r10">=</span><span class="r7"> batched_graph</span><span class="r10">.</span><span class="r7">ndata</span><span class="r10">.</span><span class="r7">pop(</span><span class="r11">&#x27;x&#x27;</span><span class="r7">)</span><span class="r9">       </span>  
 <span class="r4">  150 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total </span><span class="r10">+=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(labels)</span><span class="r9">                      </span>  
 <span class="r4">  151 </span>│       │       │       │       │       │       │              │       │<span class="r7">        logits </span><span class="r10">=</span><span class="r7"> model(batched_graph, feat</span><span class="r10">.</span><span class="r7">view(</span><span class="r12">le</span>  
 <span class="r4">  152 </span>│       │       │       │       │       │       │              │       │<span class="r7">        predicted </span><span class="r10">=</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                          </span>  
 <span class="r4">  153 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> threshold:</span><span class="r9">                             </span>  
 <span class="r4">  154 </span>│       │       │       │       │       │       │              │       │<span class="r7">            predicted </span><span class="r10">=</span><span class="r7"> (logits </span><span class="r10">&gt;</span><span class="r7"> threshold)</span><span class="r10">.</span><span class="r7">cpu()</span>  
 <span class="r4">  155 </span>│       │       │       │       │       │       │              │       │<span class="r7">            predicted </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(predicted)</span><span class="r10">.</span><span class="r7">to</span>  
 <span class="r4">  156 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  157 </span>│       │       │       │       │       │       │              │       │<span class="r7">            _, predicted </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">max(logits, </span><span class="r10">1</span><span class="r7">)</span><span class="r9">   </span>  
 <span class="r4">  158 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(predicted, labels)</span><span class="r9">                </span>  
 <span class="r4">  159 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(logits.size(), predicted.size(), l</span>  
 <span class="r4">  160 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_correct </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">==</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum</span>  
 <span class="r4">  161 </span>│       │       │       │       │       │       │              │       │<span class="r7">        m </span><span class="r10">=</span><span class="r7"> predicted </span><span class="r10">+</span><span class="r7"> labels</span><span class="r9">                    </span>  
 <span class="r4">  162 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_tp </span><span class="r10">+=</span><span class="r7"> (m </span><span class="r10">&gt;=</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">item()</span><span class="r9">         </span>  
 <span class="r4">  163 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_tn </span><span class="r10">+=</span><span class="r7"> (m </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">item()</span><span class="r9">         </span>  
 <span class="r4">  164 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_fp </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">&gt;</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">ite</span>  
 <span class="r4">  165 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_fn </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">&lt;</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">ite</span>  
 <span class="r4">  166 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(m, predicted, labels, total_tp, to</span>  
 <span class="r4">  167 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  168 </span>│       │       │       │       │       │       │              │       │<span class="r7">    acc </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1.0</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> total_correct </span><span class="r10">/</span><span class="r7"> total</span><span class="r9">             </span>  
 <span class="r4">  169 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># pre = 1.0 * total_tp / (total_tp + total_fp)</span>  
 <span class="r4">  170 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># rec = 1.0 * total_tp / (total_tp + total_fn)</span>  
 <span class="r4">  171 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># f1 = 2.0 * pre * rec / (rec + rec)</span><span class="r9">          </span>  
 <span class="r4">  172 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># print(acc, pre, rec, f1)</span><span class="r9">                    </span>  
 <span class="r4">  173 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> acc, total_tp, total_tn, total_fp, tota</span>  
 <span class="r4">  174 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  175 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  176 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">all_u_to_v</span><span class="r7">(src, dst):</span><span class="r9">                         </span>  
 <span class="r4">  177 </span>│       │       │       │       │       │       │              │       │<span class="r7">    ret </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                      </span>  
 <span class="r4">  178 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> v </span><span class="r14">in</span><span class="r7"> dst:</span><span class="r9">                                 </span>  
 <span class="r4">  179 </span>│       │       │       │       │       │       │              │       │<span class="r7">        ret </span><span class="r10">+=</span><span class="r7"> [[u, v] </span><span class="r6">for</span><span class="r7"> u </span><span class="r14">in</span><span class="r7"> src]</span><span class="r9">              </span>  
 <span class="r4">  180 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> ret</span><span class="r9">                                    </span>  
 <span class="r4">  181 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  182 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">cnn2graph</span><span class="r7">(model, model_info):</span><span class="r9">                 </span>  
 <span class="r4">  183 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># convert cnn model to a dgl graph</span><span class="r9">            </span>  
 <span class="r4">  184 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># model: model weight data</span><span class="r9">                    </span>  
 <span class="r4">  185 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># model_info: model struct info</span><span class="r9">               </span>  
 <span class="r4">  186 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  187 </span>│       │       │       │       │       │       │              │       │<span class="r7">    layers </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                   </span>  
 <span class="r4">  188 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_node_feats </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  189 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_edges </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                </span>  
 <span class="r4">  190 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cnt </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                       </span>  
 <span class="r4">  191 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">with</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">no_grad():</span><span class="r9">                         </span>  
 <span class="r4">  192 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(</span><span class="r12">len</span><span class="r7">(model_info)):</span><span class="r9">          </span>  
 <span class="r4">  193 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cur_layer_info </span><span class="r10">=</span><span class="r7"> model_info[i]</span><span class="r9">        </span>  
 <span class="r4">  194 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cur_layer_node </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                   </span>  
 <span class="r4">  195 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r9">                                      </span>  
 <span class="r4">  196 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> </span><span class="r11">&#x27;conv&#x27;</span><span class="r7"> </span><span class="r14">in</span><span class="r7"> cur_layer_info[</span><span class="r11">&#x27;name&#x27;</span><span class="r7">]:</span><span class="r9">  </span>  
 <span class="r4">  197 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># construct cur layer nodes</span><span class="r9">       </span>  
 <span class="r4">  198 </span>│       │       │       │       │       │       │              │       │<span class="r7">                weights </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_</span>  
 <span class="r4">  199 </span>│       │       │       │       │       │       │              │       │<span class="r7">                biass </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_la</span>  
 <span class="r4">  200 </span>│       │       │       │       │       │       │              │       │<span class="r7">                n </span><span class="r10">=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(biass)</span><span class="r9">                    </span>  
 <span class="r4">  201 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">for</span><span class="r7"> idx </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(n):</span><span class="r9">              </span>  
 <span class="r4">  202 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    cur_layer_node</span><span class="r10">.</span><span class="r7">append(cnt)</span><span class="r9">    </span>  
 <span class="r4">  203 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    cnt </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                      </span>  
 <span class="r4">  204 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># featue resize?</span><span class="r9">              </span>  
 <span class="r4">  205 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    w </span><span class="r10">=</span><span class="r7"> weights[idx]</span><span class="r9">              </span>  
 <span class="r4">  206 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    b </span><span class="r10">=</span><span class="r7"> biass[idx]</span><span class="r9">                </span>  
 <span class="r4">  207 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    channels, width, height </span><span class="r10">=</span><span class="r7"> w</span><span class="r10">.</span><span class="r7">si</span>  
 <span class="r4">  208 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r6">assert</span><span class="r7"> channels </span><span class="r10">*</span><span class="r7"> width </span><span class="r10">*</span><span class="r7"> heig</span>  
 <span class="r4">  209 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    w </span><span class="r10">=</span><span class="r7"> w</span><span class="r10">.</span><span class="r7">reshape(channels, width </span>  
 <span class="r4">  210 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    all_node_feats</span><span class="r10">.</span><span class="r7">append(padding(</span>  
 <span class="r4">  211 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  212 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># construct dense layer node</span><span class="r9">      </span>  
 <span class="r4">  213 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cur_layer_node</span><span class="r10">.</span><span class="r7">append(cnt)</span><span class="r9">        </span>  
 <span class="r4">  214 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cnt </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                          </span>  
 <span class="r4">  215 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># feature resize?</span><span class="r9">                 </span>  
 <span class="r4">  216 </span>│       │       │       │       │       │       │              │       │<span class="r7">                w </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_layer_</span>  
 <span class="r4">  217 </span>│       │       │       │       │       │       │              │       │<span class="r7">                all_node_feats</span><span class="r10">.</span><span class="r7">append(padding(w, </span><span class="r10">5</span>  
 <span class="r4">  218 </span>│       │       │       │       │       │       │              │       │<span class="r7">            layers</span><span class="r10">.</span><span class="r7">append(cur_layer_node)</span><span class="r9">         </span>  
 <span class="r4">  219 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r9">                                      </span>  
 <span class="r4">  220 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># get all edges</span><span class="r9">                               </span>  
 <span class="r4">  221 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> idx </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(</span><span class="r12">len</span><span class="r7">(layers)):</span><span class="r9">                </span>  
 <span class="r4">  222 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> idx </span><span class="r10">&lt;</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(layers) </span><span class="r10">-</span><span class="r7"> </span><span class="r10">1</span><span class="r7">:</span><span class="r9">                 </span>  
 <span class="r4">  223 </span>│       │       │       │       │       │       │              │       │<span class="r7">            edges </span><span class="r10">=</span><span class="r7"> all_u_to_v(layers[idx], layers</span>  
 <span class="r4">  224 </span>│       │       │       │       │       │       │              │       │<span class="r7">            all_edges </span><span class="r10">+=</span><span class="r7"> edges</span><span class="r9">                    </span>  
 <span class="r4">  225 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  226 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_edges </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(all_edges)</span><span class="r10">.</span><span class="r7">t()</span><span class="r9">       </span>  
 <span class="r4">  227 </span>│       │       │       │       │       │       │              │       │<span class="r7">    u, v </span><span class="r10">=</span><span class="r7"> all_edges[</span><span class="r10">0</span><span class="r7">], all_edges[</span><span class="r10">1</span><span class="r7">]</span><span class="r9">             </span>  
 <span class="r4">  228 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g </span><span class="r10">=</span><span class="r7"> dgl</span><span class="r10">.</span><span class="r7">graph((u,v))</span><span class="r10">.</span><span class="r7">to(</span><span class="r11">&#x27;cuda&#x27;</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  229 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;x&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">stack(all_node_feats)</span><span class="r9">    </span>  
 <span class="r4">  230 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> g</span><span class="r9">                                      </span>  
 <span class="r4">  231 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  232 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  233 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">cnn2graph_activation</span><span class="r7">(model, model_info):</span><span class="r9">      </span>  
 <span class="r4">  234 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># convert cnn model to a dgl graph</span><span class="r9">            </span>  
 <span class="r4">  235 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># model: model weight data</span><span class="r9">                    </span>  
 <span class="r4">  236 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># model_info: model struct info</span><span class="r9">               </span>  
 <span class="r4">  237 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  238 </span>│       │       │       │       │       │       │              │       │<span class="r7">    layers </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                   </span>  
 <span class="r4">  239 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_edges </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                </span>  
 <span class="r4">  240 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  241 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  242 </span>│       │       │       │       │       │       │              │       │<span class="r7">    node_layer_idx </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  243 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_node_feats </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  244 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pre_node_size </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                            </span>  
 <span class="r4">  245 </span>│       │       │       │       │       │       │              │       │<span class="r7">    node_params </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                              </span>  
 <span class="r4">  246 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_bias_feats </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  247 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pre_bias_size </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                            </span>  
 <span class="r4">  248 </span>│       │       │       │       │       │       │              │       │<span class="r7">    node_layer_num </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                           </span>  
 <span class="r4">  249 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  250 </span>│       │       │       │       │       │       │              │       │<span class="r7">    pooling </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                                  </span>  
 <span class="r4">  251 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  252 </span>│       │       │       │       │       │       │              │       │<span class="r7">    idx </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                       </span>  
 <span class="r4">  253 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cnt </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                       </span>  
 <span class="r4">  254 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">with</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">no_grad():</span><span class="r9">                         </span>  
 <span class="r4">  255 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(</span><span class="r12">len</span><span class="r7">(model_info)):</span><span class="r9">          </span>  
 <span class="r4">  256 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cur_layer_info </span><span class="r10">=</span><span class="r7"> model_info[i]</span><span class="r9">        </span>  
 <span class="r4">  257 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pooling_info </span><span class="r10">=</span><span class="r7"> cur_layer_info[</span><span class="r11">&#x27;maxpool</span>  
 <span class="r4">  258 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r15"># print(pooling_info)</span><span class="r9">                 </span>  
 <span class="r4">  259 </span>│       │       │       │       │       │       │              │       │<span class="r7">            cur_layer_node </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                   </span>  
 <span class="r4">  260 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> </span><span class="r11">&#x27;conv&#x27;</span><span class="r7"> </span><span class="r14">in</span><span class="r7"> cur_layer_info[</span><span class="r11">&#x27;name&#x27;</span><span class="r7">]:</span><span class="r9">  </span>  
 <span class="r4">  261 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># construct cur layer nodes</span><span class="r9">       </span>  
 <span class="r4">  262 </span>│       │       │       │       │       │       │              │       │<span class="r7">                weights </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_</span>  
 <span class="r4">  263 </span>│       │       │       │       │       │       │              │       │<span class="r7">                biass </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_la</span>  
 <span class="r4">  264 </span>│       │       │       │       │       │       │              │       │<span class="r7">                n </span><span class="r10">=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(biass)</span><span class="r9">                    </span>  
 <span class="r4">  265 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r6">for</span><span class="r7"> inner_idx </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(n):</span><span class="r9">        </span>  
 <span class="r4">  266 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># print(&quot;cur layer info:&quot;, mod</span>  
 <span class="r4">  267 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    cur_layer_node</span><span class="r10">.</span><span class="r7">append(cnt)</span><span class="r9">    </span>  
 <span class="r4">  268 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    cnt </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                      </span>  
 <span class="r4">  269 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r6">if</span><span class="r7"> pooling_info:</span><span class="r9">              </span>  
 <span class="r4">  270 </span>│       │       │       │       │       │       │              │       │<span class="r7">                        pooling</span><span class="r10">.</span><span class="r7">append([pooling_in</span>  
 <span class="r4">  271 </span>│       │       │       │       │       │       │              │       │<span class="r7">                        pooling_info[</span><span class="r11">&#x27;padding&#x27;</span><span class="r7">], p</span>  
 <span class="r4">  272 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                         </span>  
 <span class="r4">  273 </span>│       │       │       │       │       │       │              │       │<span class="r7">                        pooling</span><span class="r10">.</span><span class="r7">append([</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span>  
 <span class="r4">  274 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    node_layer_idx</span><span class="r10">.</span><span class="r7">append(idx)</span><span class="r9">    </span>  
 <span class="r4">  275 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    node_layer_num</span><span class="r10">.</span><span class="r7">append(</span><span class="r10">0</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  276 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># params </span><span class="r9">                     </span>  
 <span class="r4">  277 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    conv </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur</span>  
 <span class="r4">  278 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    params </span><span class="r10">=</span><span class="r7"> [conv</span><span class="r10">.</span><span class="r7">kernel_size, co</span>  
 <span class="r4">  279 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    node_params</span><span class="r10">.</span><span class="r7">append(params)</span><span class="r9">    </span>  
 <span class="r4">  280 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># print(params)</span><span class="r9">               </span>  
 <span class="r4">  281 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># featue resize?</span><span class="r9">              </span>  
 <span class="r4">  282 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    w </span><span class="r10">=</span><span class="r7"> weights[inner_idx]</span><span class="r9">        </span>  
 <span class="r4">  283 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    channels, width, height </span><span class="r10">=</span><span class="r7"> w</span><span class="r10">.</span><span class="r7">si</span>  
 <span class="r4">  284 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    pre_node_size</span><span class="r10">.</span><span class="r7">append([channels</span>  
 <span class="r4">  285 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r6">assert</span><span class="r7"> channels </span><span class="r10">*</span><span class="r7"> width </span><span class="r10">*</span><span class="r7"> heig</span>  
 <span class="r4">  286 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    w </span><span class="r10">=</span><span class="r7"> w</span><span class="r10">.</span><span class="r7">reshape(channels, width </span>  
 <span class="r4">  287 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    all_node_feats</span><span class="r10">.</span><span class="r7">append(padding(</span>  
 <span class="r4">  288 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    b </span><span class="r10">=</span><span class="r7"> biass[inner_idx]</span><span class="r10">.</span><span class="r7">expand(</span><span class="r10">1</span><span class="r7">,</span>  
 <span class="r4">  289 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    r, c </span><span class="r10">=</span><span class="r7"> b</span><span class="r10">.</span><span class="r7">size()</span><span class="r9">               </span>  
 <span class="r4">  290 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># print(&quot;size:&quot;, b.size())</span><span class="r9">    </span>  
 <span class="r4">  291 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    pre_bias_size</span><span class="r10">.</span><span class="r7">append([r, c])</span><span class="r9">  </span>  
 <span class="r4">  292 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    all_bias_feats</span><span class="r10">.</span><span class="r7">append(padding(</span>  
 <span class="r4">  293 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># print(&quot;conv weight:&quot;, w.shap</span>  
 <span class="r4">  294 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># bias</span><span class="r9">                        </span>  
 <span class="r4">  295 </span>│       │       │       │       │       │       │              │       │<span class="r7">                    </span><span class="r15"># print(&quot;conv bias:&quot;, bias)</span><span class="r9">   </span>  
 <span class="r4">  296 </span>│       │       │       │       │       │       │              │       │<span class="r7">                idx </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                          </span>  
 <span class="r4">  297 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  298 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># construct dense layer node</span><span class="r9">      </span>  
 <span class="r4">  299 </span>│       │       │       │       │       │       │              │       │<span class="r7">                pooling</span><span class="r10">.</span><span class="r7">append([</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">])</span><span class="r9">   </span>  
 <span class="r4">  300 </span>│       │       │       │       │       │       │              │       │<span class="r7">                node_layer_num</span><span class="r10">.</span><span class="r7">append(</span><span class="r10">1</span><span class="r7">)</span><span class="r9">          </span>  
 <span class="r4">  301 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cur_layer_node</span><span class="r10">.</span><span class="r7">append(cnt)</span><span class="r9">        </span>  
 <span class="r4">  302 </span>│       │       │       │       │       │       │              │       │<span class="r7">                cnt </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                          </span>  
 <span class="r4">  303 </span>│       │       │       │       │       │       │              │       │<span class="r7">                node_layer_idx</span><span class="r10">.</span><span class="r7">append(idx)</span><span class="r9">        </span>  
 <span class="r4">  304 </span>│       │       │       │       │       │       │              │       │<span class="r7">                idx </span><span class="r10">+=</span><span class="r7"> </span><span class="r10">1</span><span class="r9">                          </span>  
 <span class="r4">  305 </span>│       │       │       │       │       │       │              │       │<span class="r7">                params </span><span class="r10">=</span><span class="r7"> [(</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">), (</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">), (</span><span class="r10">0</span><span class="r7">, </span><span class="r10">0</span><span class="r7">)]</span><span class="r9"> </span>  
 <span class="r4">  306 </span>│       │       │       │       │       │       │              │       │<span class="r7">                node_params</span><span class="r10">.</span><span class="r7">append(params)</span><span class="r9">        </span>  
 <span class="r4">  307 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># feature resize?</span><span class="r9">                 </span>  
 <span class="r4">  308 </span>│       │       │       │       │       │       │              │       │<span class="r7">                weight </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_l</span>  
 <span class="r4">  309 </span>│       │       │       │       │       │       │              │       │<span class="r7">                bias </span><span class="r10">=</span><span class="r7"> model</span><span class="r10">.</span><span class="r7">get_submodule(cur_lay</span>  
 <span class="r4">  310 </span>│       │       │       │       │       │       │              │       │<span class="r7">                w </span><span class="r10">=</span><span class="r7"> weight</span><span class="r9">                        </span>  
 <span class="r4">  311 </span>│       │       │       │       │       │       │              │       │<span class="r7">                r, c </span><span class="r10">=</span><span class="r7"> w</span><span class="r10">.</span><span class="r7">size()</span><span class="r9">                   </span>  
 <span class="r4">  312 </span>│       │       │       │       │       │       │              │       │<span class="r7">                pre_node_size</span><span class="r10">.</span><span class="r7">append([</span><span class="r10">1</span><span class="r7">, r, c])</span><span class="r9">   </span>  
 <span class="r4">  313 </span>│       │       │       │       │       │       │              │       │<span class="r7">                all_node_feats</span><span class="r10">.</span><span class="r7">append(padding(w, </span><span class="r10">5</span>  
 <span class="r4">  314 </span>│       │       │       │       │       │       │              │       │<span class="r7">                b </span><span class="r10">=</span><span class="r7"> bias</span><span class="r10">.</span><span class="r7">expand(</span><span class="r10">1</span><span class="r7">,</span><span class="r10">-1</span><span class="r7">)</span><span class="r9">             </span>  
 <span class="r4">  315 </span>│       │       │       │       │       │       │              │       │<span class="r7">                r, c </span><span class="r10">=</span><span class="r7"> b</span><span class="r10">.</span><span class="r7">size()</span><span class="r9">                   </span>  
 <span class="r4">  316 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r15"># print(&quot;size:&quot;, b.size())</span><span class="r9">        </span>  
 <span class="r4">  317 </span>│       │       │       │       │       │       │              │       │<span class="r7">                pre_bias_size</span><span class="r10">.</span><span class="r7">append([r, c])</span><span class="r9">      </span>  
 <span class="r4">  318 </span>│       │       │       │       │       │       │              │       │<span class="r7">                all_bias_feats</span><span class="r10">.</span><span class="r7">append(padding(b, </span><span class="r10">1</span>  
 <span class="r4">  319 </span>│       │       │       │       │       │       │              │       │<span class="r7">            layers</span><span class="r10">.</span><span class="r7">append(cur_layer_node)</span><span class="r9">         </span>  
 <span class="r4">  320 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r9">                                      </span>  
 <span class="r4">  321 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># get all edges</span><span class="r9">                               </span>  
 <span class="r4">  322 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> idx </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(</span><span class="r12">len</span><span class="r7">(layers)):</span><span class="r9">                </span>  
 <span class="r4">  323 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> idx </span><span class="r10">&lt;</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(layers) </span><span class="r10">-</span><span class="r7"> </span><span class="r10">1</span><span class="r7">:</span><span class="r9">                 </span>  
 <span class="r4">  324 </span>│       │       │       │       │       │       │              │       │<span class="r7">            edges </span><span class="r10">=</span><span class="r7"> all_u_to_v(layers[idx], layers</span>  
 <span class="r4">  325 </span>│       │       │       │       │       │       │              │       │<span class="r7">            all_edges </span><span class="r10">+=</span><span class="r7"> edges</span><span class="r9">                    </span>  
 <span class="r4">  326 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  327 </span>│       │       │       │       │       │       │              │       │<span class="r7">    all_edges </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(all_edges)</span><span class="r10">.</span><span class="r7">t()</span><span class="r9">       </span>  
 <span class="r4">  328 </span>│       │       │       │       │       │       │              │       │<span class="r7">    u, v </span><span class="r10">=</span><span class="r7"> all_edges[</span><span class="r10">0</span><span class="r7">], all_edges[</span><span class="r10">1</span><span class="r7">]</span><span class="r9">             </span>  
 <span class="r4">  329 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g </span><span class="r10">=</span><span class="r7"> dgl</span><span class="r10">.</span><span class="r7">graph((u,v))</span><span class="r10">.</span><span class="r7">to(</span><span class="r11">&#x27;cuda&#x27;</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  330 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;kernel_weight&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">stack(all_nod</span>  
 <span class="r4">  331 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># tag for message transmission process</span><span class="r9">        </span>  
 <span class="r4">  332 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;layer_idx&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(node_layer</span>  
 <span class="r4">  333 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># layer for layer type, 0 for conv, 1 for full</span>  
 <span class="r4">  334 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;layer_type&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(node_laye</span>  
 <span class="r4">  335 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># acutal node size(kernel size or fc node size</span>  
 <span class="r4">  336 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;kernel_size&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(pre_node</span>  
 <span class="r4">  337 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># params for conv kernel params </span><span class="r9">              </span>  
 <span class="r4">  338 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;kernel_params&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(node_p</span>  
 <span class="r4">  339 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># bias weight</span><span class="r9">                                 </span>  
 <span class="r4">  340 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;bias&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">stack(all_bias_feats)</span><span class="r9"> </span>  
 <span class="r4">  341 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># bias size</span><span class="r9">                                   </span>  
 <span class="r4">  342 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;bias_size&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(pre_bias_s</span>  
 <span class="r4">  343 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># pooling params</span><span class="r9">                              </span>  
 <span class="r4">  344 </span>│       │       │       │       │       │       │              │       │<span class="r7">    g</span><span class="r10">.</span><span class="r7">ndata[</span><span class="r11">&#x27;pooling_params&#x27;</span><span class="r7">] </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(pooli</span>  
 <span class="r4">  345 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  346 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> g</span><span class="r9">                                      </span>  
 <span class="r4">  347 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  348 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  349 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  350 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">padding</span><span class="r7">(src: torch</span><span class="r10">.</span><span class="r7">Tensor, row: </span><span class="r12">int</span><span class="r7">, col: </span><span class="r12">int</span><span class="r7">)</span>  
 <span class="r4">  351 </span>│       │       │       │       │       │       │              │       │<span class="r7">    r, c </span><span class="r10">=</span><span class="r7"> src</span><span class="r10">.</span><span class="r7">size()</span><span class="r9">                             </span>  
 <span class="r4">  352 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  353 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> r </span><span class="r10">&gt;</span><span class="r7"> row </span><span class="r14">or</span><span class="r7"> c </span><span class="r10">&gt;</span><span class="r7"> col:</span><span class="r9">                        </span>  
 <span class="r4">  354 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                               </span>  
 <span class="r4">  355 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  356 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> (row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">%</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  357 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  358 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  359 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r10">1</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  360 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  361 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> row </span><span class="r10">==</span><span class="r7"> r:</span><span class="r9">                                  </span>  
 <span class="r4">  362 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rr </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                    </span>  
 <span class="r4">  363 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  364 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rr </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  365 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  366 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> (col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">%</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  367 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  368 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  369 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r10">1</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  370 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  371 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> col </span><span class="r10">==</span><span class="r7"> c:</span><span class="r9">                                  </span>  
 <span class="r4">  372 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cr </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                    </span>  
 <span class="r4">  373 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  374 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cr </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  375 </span>│       │       │       │       │       │       │              │       │<span class="r7">   </span><span class="r9">                                               </span>  
 <span class="r4">  376 </span>│       │       │       │       │       │       │              │       │<span class="r7">    result </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">pad(</span><span class="r12">input</span><span class="r10">=</span><span class="r7">src, pad</span><span class="r10">=</span><span class="r7">(cl, cr, rl, rr)</span>  
 <span class="r4">  377 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> result</span><span class="r9">                                 </span>  
 <span class="r4">  378 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  379 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">unpadding</span><span class="r7">(src: torch</span><span class="r10">.</span><span class="r7">Tensor, row: </span><span class="r12">int</span><span class="r7">, col: </span><span class="r12">in</span>  
 <span class="r4">  380 </span>│       │       │       │       │       │       │              │       │<span class="r7">    r, c </span><span class="r10">=</span><span class="r7"> src</span><span class="r10">.</span><span class="r7">size()</span><span class="r9">                             </span>  
 <span class="r4">  381 </span>│       │       │       │       │       │       │              │       │<span class="r7">    r, c, row, col </span><span class="r10">=</span><span class="r7"> row, col, r, c</span><span class="r9">               </span>  
 <span class="r4">  382 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> r </span><span class="r10">&gt;</span><span class="r7"> row </span><span class="r14">or</span><span class="r7"> c </span><span class="r10">&gt;</span><span class="r7"> col:</span><span class="r9">                        </span>  
 <span class="r4">  383 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                               </span>  
 <span class="r4">  384 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  385 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> (row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">%</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  386 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  387 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  388 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r10">1</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  389 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  390 </span>│       │       │       │       │       │       │              │       │<span class="r7">    rr </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((row </span><span class="r10">-</span><span class="r7"> r) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                       </span>  
 <span class="r4">  391 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> rr </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                                   </span>  
 <span class="r4">  392 </span>│       │       │       │       │       │       │              │       │<span class="r7">        rr </span><span class="r10">=</span><span class="r7"> </span><span class="r10">-</span><span class="r7">row</span><span class="r9">                                 </span>  
 <span class="r4">  393 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  394 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> (col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">%</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  395 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                   </span>  
 <span class="r4">  396 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  397 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cl </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r10">1</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  398 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  399 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cr </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">((col </span><span class="r10">-</span><span class="r7"> c) </span><span class="r10">/</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r9">                       </span>  
 <span class="r4">  400 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> cr </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                                   </span>  
 <span class="r4">  401 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cr </span><span class="r10">=</span><span class="r7"> </span><span class="r10">-</span><span class="r7">col</span><span class="r9">                                 </span>  
 <span class="r4">  402 </span>│       │       │       │       │       │       │              │       │<span class="r7">   </span><span class="r9">                                               </span>  
 <span class="r4">  403 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># print(cl, cr, rl, rr)</span><span class="r9">                       </span>  
 <span class="r4">  404 </span>│       │       │       │       │       │       │              │       │<span class="r7">    result </span><span class="r10">=</span><span class="r7"> src[rl:</span><span class="r10">-</span><span class="r7">rr, cl:</span><span class="r10">-</span><span class="r7">cr]</span><span class="r9">                  </span>  
 <span class="r4">  405 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> result</span><span class="r9">                                 </span>  
 <span class="r4">  406 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  407 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">load_dataset</span><span class="r7">(shadow_path, is_specific, troj_ty</span>  
 <span class="r4">  408 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r21">&#x27;&#x27;&#x27;get the data path list of train/val/test da</span>  
 <span class="r4">  409 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">seed</span><span class="r7">():</span><span class="r9">                                   </span>  
 <span class="r4">  410 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> </span><span class="r14">not</span><span class="r7"> is_specific:</span><span class="r9">                       </span>  
 <span class="r4">  411 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r21">&#x27;&#x27;&#x27;load hetero structure model in rand</span>  
 <span class="r4">  412 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">return</span><span class="r7"> </span><span class="r12">str</span><span class="r7">(randint(</span><span class="r10">0</span><span class="r7">,</span><span class="r10">5</span><span class="r7">))</span><span class="r9">              </span>  
 <span class="r4">  413 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  414 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r21">&#x27;&#x27;&#x27;load same structure in specific pat</span>  
 <span class="r4">  415 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">return</span><span class="r7"> is_specific</span><span class="r9">                    </span>  
 <span class="r4">  416 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  417 </span>│       │       │       │       │       │       │              │       │<span class="r7">    train_dataset </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                            </span>  
 <span class="r4">  418 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> i </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(TRAIN_NUM):</span><span class="r9">                    </span>  
 <span class="r4">  419 </span>│       │       │       │       │       │       │              │       │<span class="r7">        idx </span><span class="r10">=</span><span class="r7"> seed()</span><span class="r9">                              </span>  
 <span class="r4">  420 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/shadow_jumbo_</span><span class="r19">%d</span><span class="r11">.model&#x27;</span>  
 <span class="r4">  421 </span>│       │       │       │       │       │       │              │       │<span class="r7">        train_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">1</span><span class="r7">,idx))</span><span class="r9">           </span>  
 <span class="r4">  422 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/shadow_benign_</span><span class="r19">%d</span><span class="r11">.model</span>  
 <span class="r4">  423 </span>│       │       │       │       │       │       │              │       │<span class="r7">        train_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">0</span><span class="r7">,idx))</span><span class="r9">           </span>  
 <span class="r4">  424 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  425 </span>│       │       │       │       │       │       │              │       │<span class="r7">    val_dataset </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                              </span>  
 <span class="r4">  426 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> i </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(TRAIN_NUM, TRAIN_NUM</span><span class="r10">+</span><span class="r7">VAL_NUM):</span><span class="r9"> </span>  
 <span class="r4">  427 </span>│       │       │       │       │       │       │              │       │<span class="r7">        idx </span><span class="r10">=</span><span class="r7"> seed()</span><span class="r9">                              </span>  
 <span class="r4">  428 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/shadow_jumbo_</span><span class="r19">%d</span><span class="r11">.model&#x27;</span>  
 <span class="r4">  429 </span>│       │       │       │       │       │       │              │       │<span class="r7">        val_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">1</span><span class="r7">,idx))</span><span class="r9">             </span>  
 <span class="r4">  430 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/shadow_benign_</span><span class="r19">%d</span><span class="r11">.model</span>  
 <span class="r4">  431 </span>│       │       │       │       │       │       │              │       │<span class="r7">        val_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">0</span><span class="r7">,idx))</span><span class="r9">             </span>  
 <span class="r4">  432 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  433 </span>│       │       │       │       │       │       │              │       │<span class="r7">    test_dataset </span><span class="r10">=</span><span class="r7"> []</span><span class="r9">                             </span>  
 <span class="r4">  434 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> i </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(TEST_NUM):</span><span class="r9">                     </span>  
 <span class="r4">  435 </span>│       │       │       │       │       │       │              │       │<span class="r7">        idx </span><span class="r10">=</span><span class="r7"> seed()</span><span class="r9">                              </span>  
 <span class="r4">  436 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;_hetero&#x27;</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/target_tro</span>  
 <span class="r4">  437 </span>│       │       │       │       │       │       │              │       │<span class="r7">        test_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">1</span><span class="r7">,idx))</span><span class="r9">            </span>  
 <span class="r4">  438 </span>│       │       │       │       │       │       │              │       │<span class="r7">        x </span><span class="r10">=</span><span class="r7"> shadow_path </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;_hetero&#x27;</span><span class="r7"> </span><span class="r10">+</span><span class="r7"> </span><span class="r11">&#x27;/target_ben</span>  
 <span class="r4">  439 </span>│       │       │       │       │       │       │              │       │<span class="r7">        test_dataset</span><span class="r10">.</span><span class="r7">append((x,</span><span class="r10">0</span><span class="r7">,idx))</span><span class="r9">            </span>  
 <span class="r4">  440 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> train_dataset, val_dataset, test_datase</span>  
 <span class="r4">  441 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  442 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  443 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  444 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  445 </span>│       │       │       │       │       │       │              │       │<span class="r6">class</span><span class="r7"> </span><span class="r8">SGNACT</span><span class="r7">(nn</span><span class="r10">.</span><span class="r7">Module):</span><span class="r9">                          </span>  
 <span class="r4">  446 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">__init__</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, input_dim, hidden_dim, outp</span>  
 <span class="r4">  447 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">super</span><span class="r7">()</span><span class="r10">.</span><span class="r13">__init__</span><span class="r7">()</span><span class="r9">                        </span>  
 <span class="r4">  448 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">assert</span><span class="r7"> pooling </span><span class="r14">in</span><span class="r7"> [</span><span class="r11">&#x27;sum&#x27;</span><span class="r7">, </span><span class="r11">&#x27;avg&#x27;</span><span class="r7">, </span><span class="r11">&#x27;max&#x27;</span><span class="r7">], </span><span class="r11">&quot;</span>  
 <span class="r4">  449 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">          </span>  
 <span class="r4">  450 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">        </span>  
 <span class="r4">  451 </span>│       │       │       │       │       │       │              │       │<span class="r7">        num_layers </span><span class="r10">=</span><span class="r7"> </span><span class="r10">2</span><span class="r9">                            </span>  
 <span class="r4">  452 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># five-layer GCN with two-layer MLP aggreg</span>  
 <span class="r4">  453 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(num_layers </span><span class="r10">-</span><span class="r7"> </span><span class="r10">1</span><span class="r7">): </span><span class="r15"># excl</span>  
 <span class="r4">  454 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> layer </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  455 </span>│       │       │       │       │       │       │              │       │<span class="r7">                mlp </span><span class="r10">=</span><span class="r7"> MLP(input_dim, hidden_dim, h</span>  
 <span class="r4">  456 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  457 </span>│       │       │       │       │       │       │              │       │<span class="r7">                mlp </span><span class="r10">=</span><span class="r7"> MLP(hidden_dim, hidden_dim, </span>  
 <span class="r4">  458 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers</span><span class="r10">.</span><span class="r7">append(GINConv(mlp, lea</span>  
 <span class="r4">  459 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">BatchNorm1d</span>  
 <span class="r4">  460 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># linear functions for graph sum poolings </span>  
 <span class="r4">  461 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">ModuleList()</span><span class="r9">  </span>  
 <span class="r4">  462 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(num_layers):</span><span class="r9">           </span>  
 <span class="r4">  463 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">if</span><span class="r7"> layer </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">:</span><span class="r9">                        </span>  
 <span class="r4">  464 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">  465 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                 </span>  
 <span class="r4">  466 </span>│       │       │       │       │       │       │              │       │<span class="r7">                </span><span class="r12">self</span><span class="r10">.</span><span class="r7">linear_prediction</span><span class="r10">.</span><span class="r7">append(nn</span><span class="r10">.</span><span class="r7">L</span>  
 <span class="r4">  467 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop </span><span class="r10">=</span><span class="r7"> nn</span><span class="r10">.</span><span class="r7">Dropout(</span><span class="r10">0.8</span><span class="r7">)</span><span class="r9">               </span>  
 <span class="r4">  468 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> pooling </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;sum&#x27;</span><span class="r7">:</span><span class="r9">                      </span>  
 <span class="r4">  469 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> SumPooling() </span><span class="r15"># change to m</span>  
 <span class="r4">  470 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">elif</span><span class="r7"> pooling </span><span class="r10">==</span><span class="r7"> </span><span class="r11">&#x27;avg&#x27;</span><span class="r7">:</span><span class="r9">                    </span>  
 <span class="r4">  471 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> AvgPooling()</span><span class="r9">              </span>  
 <span class="r4">  472 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  473 </span>│       │       │       │       │       │       │              │       │<span class="r7">            </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool </span><span class="r10">=</span><span class="r7"> MaxPooling()</span><span class="r9">              </span>  
 <span class="r4">  474 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.topK = topK</span><span class="r9">                        </span>  
 <span class="r4">  475 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.pool = SortPooling(topK)</span><span class="r9">           </span>  
 <span class="r4">  476 </span>│       │       │       │       │       │       │              │       │<span class="r15">#         self.pool = AvgPooling()</span><span class="r9">                </span>  
 <span class="r4">  477 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r9">                                          </span>  
 <span class="r4">  478 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, image, g, h):</span><span class="r9">               </span>  
 <span class="r4">  479 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># list of hidden representation at each la</span>  
 <span class="r4">  480 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># img_class = cnn_foward()</span><span class="r9">                </span>  
 <span class="r4">  481 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># gnn_class = gnn_foward()</span><span class="r9">                </span>  
 <span class="r4">  482 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># return img_class, gnn_class </span><span class="r9">            </span>  
 <span class="r4">  483 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">self</span><span class="r10">.</span><span class="r7">cnn_forward(image, g, h)</span><span class="r9">             </span>  
 <span class="r4">  484 </span>│       │       │       │       │       │       │              │       │<span class="r7">        score_over_layer </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">gnn_forward(g, h)</span><span class="r9"> </span>  
 <span class="r4">  485 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> score_over_layer</span><span class="r9">                   </span>  
 <span class="r4">  486 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  487 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">cnn_forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, image, g, h):</span><span class="r9">           </span>  
 <span class="r4">  488 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(&quot;Image Got:&quot;, image)</span><span class="r9">              </span>  
 <span class="r4">  489 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(&quot;cnn_forward called!&quot;)</span><span class="r9">            </span>  
 <span class="r4">  490 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">print</span><span class="r7">(g</span><span class="r10">.</span><span class="r7">ndata)</span><span class="r9">                            </span>  
 <span class="r4">  491 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">input</span><span class="r7">()</span><span class="r9">                                   </span>  
 <span class="r4">  492 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">pass</span><span class="r9">                                      </span>  
 <span class="r4">  493 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  494 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">def</span><span class="r7"> </span><span class="r13">gnn_forward</span><span class="r7">(</span><span class="r12">self</span><span class="r7">, g, h):</span><span class="r9">                  </span>  
 <span class="r4">  495 </span>│       │       │       │       │       │       │              │       │<span class="r7">        hidden_rep </span><span class="r10">=</span><span class="r7"> [h]</span><span class="r9">                          </span>  
 <span class="r4">  496 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, layer </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">ginlayers):</span>  
 <span class="r4">  497 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> layer(g, h)</span><span class="r9">                       </span>  
 <span class="r4">  498 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">batch_norms[i](h)</span><span class="r9">            </span>  
 <span class="r4">  499 </span>│       │       │       │       │       │       │              │       │<span class="r7">            h </span><span class="r10">=</span><span class="r7"> F</span><span class="r10">.</span><span class="r7">relu(h)</span><span class="r9">                         </span>  
 <span class="r4">  500 </span>│       │       │       │       │       │       │              │       │<span class="r7">            hidden_rep</span><span class="r10">.</span><span class="r7">append(h)</span><span class="r9">                  </span>  
 <span class="r4">  501 </span>│       │       │       │       │       │       │              │       │<span class="r7">        score_over_layer </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                      </span>  
 <span class="r4">  502 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># perform graph sum pooling over all nodes</span>  
 <span class="r4">  503 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">for</span><span class="r7"> i, h </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerate</span><span class="r7">(hidden_rep):</span><span class="r9">        </span>  
 <span class="r4">  504 </span>│       │       │       │       │       │       │              │       │<span class="r7">            pooled_h </span><span class="r10">=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">pool(g, h)</span><span class="r9">            </span>  
 <span class="r4">  505 </span>│       │       │       │       │       │       │              │       │<span class="r7">            score_over_layer </span><span class="r10">+=</span><span class="r7"> </span><span class="r12">self</span><span class="r10">.</span><span class="r7">drop(</span><span class="r12">self</span><span class="r10">.</span><span class="r7">lin</span>  
 <span class="r4">  506 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> score_over_layer</span><span class="r9">                   </span>  
 <span class="r4">  507 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  508 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  509 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">evaluateACT</span><span class="r7">(dataloader, device, model, thresho</span>  
 <span class="r4">  510 </span>│       │       │       │       │       │       │              │       │<span class="r7">    model</span><span class="r10">.</span><span class="r7">eval()</span><span class="r9">                                  </span>  
 <span class="r4">  511 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                     </span>  
 <span class="r4">  512 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_correct </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                             </span>  
 <span class="r4">  513 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_tp </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  514 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_fp </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  515 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_tn </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  516 </span>│       │       │       │       │       │       │              │       │<span class="r7">    total_fn </span><span class="r10">=</span><span class="r7"> </span><span class="r10">0</span><span class="r9">                                  </span>  
 <span class="r4">  517 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> batch, (batched_graph, labels) </span><span class="r14">in</span><span class="r7"> </span><span class="r12">enumerat</span>  
 <span class="r4">  518 </span>│       │       │       │       │       │       │              │       │<span class="r7">        batched_graph </span><span class="r10">=</span><span class="r7"> batched_graph</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">  </span>  
 <span class="r4">  519 </span>│       │       │       │       │       │       │              │       │<span class="r7">        labels </span><span class="r10">=</span><span class="r7"> labels</span><span class="r10">.</span><span class="r7">to(device)</span><span class="r9">                </span>  
 <span class="r4">  520 </span>│       │       │       │       │       │       │              │       │<span class="r7">        feat </span><span class="r10">=</span><span class="r7"> batched_graph</span><span class="r10">.</span><span class="r7">ndata</span><span class="r10">.</span><span class="r7">pop(</span><span class="r11">&#x27;x&#x27;</span><span class="r7">)</span><span class="r9">       </span>  
 <span class="r4">  521 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total </span><span class="r10">+=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(labels)</span><span class="r9">                      </span>  
 <span class="r4">  522 </span>│       │       │       │       │       │       │              │       │<span class="r7">        image </span><span class="r10">=</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                              </span>  
 <span class="r4">  523 </span>│       │       │       │       │       │       │              │       │<span class="r7">        logits </span><span class="r10">=</span><span class="r7"> model(image, batched_graph, feat</span><span class="r10">.</span>  
 <span class="r4">  524 </span>│       │       │       │       │       │       │              │       │<span class="r7">        predicted </span><span class="r10">=</span><span class="r7"> </span><span class="r6">None</span><span class="r9">                          </span>  
 <span class="r4">  525 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">if</span><span class="r7"> threshold:</span><span class="r9">                             </span>  
 <span class="r4">  526 </span>│       │       │       │       │       │       │              │       │<span class="r7">            predicted </span><span class="r10">=</span><span class="r7"> (logits </span><span class="r10">&gt;</span><span class="r7"> threshold)</span><span class="r10">.</span><span class="r7">cpu()</span>  
 <span class="r4">  527 </span>│       │       │       │       │       │       │              │       │<span class="r7">            predicted </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">tensor(predicted)</span><span class="r10">.</span><span class="r7">to</span>  
 <span class="r4">  528 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                     </span>  
 <span class="r4">  529 </span>│       │       │       │       │       │       │              │       │<span class="r7">            _, predicted </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">max(logits, </span><span class="r10">1</span><span class="r7">)</span><span class="r9">   </span>  
 <span class="r4">  530 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(predicted, labels)</span><span class="r9">                </span>  
 <span class="r4">  531 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r12">print</span><span class="r7">(logits</span><span class="r10">.</span><span class="r7">size(), predicted</span><span class="r10">.</span><span class="r7">size(), lab</span>  
 <span class="r4">  532 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_correct </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">==</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum</span>  
 <span class="r4">  533 </span>│       │       │       │       │       │       │              │       │<span class="r7">        m </span><span class="r10">=</span><span class="r7"> predicted </span><span class="r10">+</span><span class="r7"> labels</span><span class="r9">                    </span>  
 <span class="r4">  534 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_tp </span><span class="r10">+=</span><span class="r7"> (m </span><span class="r10">&gt;=</span><span class="r7"> </span><span class="r10">2</span><span class="r7">)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">item()</span><span class="r9">         </span>  
 <span class="r4">  535 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_tn </span><span class="r10">+=</span><span class="r7"> (m </span><span class="r10">==</span><span class="r7"> </span><span class="r10">0</span><span class="r7">)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">item()</span><span class="r9">         </span>  
 <span class="r4">  536 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_fp </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">&gt;</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">ite</span>  
 <span class="r4">  537 </span>│       │       │       │       │       │       │              │       │<span class="r7">        total_fn </span><span class="r10">+=</span><span class="r7"> (predicted </span><span class="r10">&lt;</span><span class="r7"> labels)</span><span class="r10">.</span><span class="r7">sum()</span><span class="r10">.</span><span class="r7">ite</span>  
 <span class="r4">  538 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># print(m, predicted, labels, total_tp, to</span>  
 <span class="r4">  539 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  540 </span>│       │       │       │       │       │       │              │       │<span class="r7">    acc </span><span class="r10">=</span><span class="r7"> </span><span class="r10">1.0</span><span class="r7"> </span><span class="r10">*</span><span class="r7"> total_correct </span><span class="r10">/</span><span class="r7"> total</span><span class="r9">             </span>  
 <span class="r4">  541 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># pre = 1.0 * total_tp / (total_tp + total_fp)</span>  
 <span class="r4">  542 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># rec = 1.0 * total_tp / (total_tp + total_fn)</span>  
 <span class="r4">  543 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># f1 = 2.0 * pre * rec / (rec + rec)</span><span class="r9">          </span>  
 <span class="r4">  544 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># print(acc, pre, rec, f1)</span><span class="r9">                    </span>  
 <span class="r4">  545 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> acc, total_tp, total_tn, total_fp, tota</span>  
 <span class="r4">  546 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  547 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">equals</span><span class="r7">(x, y</span><span class="r10">=</span><span class="r6">None</span><span class="r7">, zeros</span><span class="r10">=</span><span class="r6">False</span><span class="r7">, precision</span><span class="r10">=1e-5</span><span class="r7">)</span>  
 <span class="r4">  548 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> zeros:</span><span class="r9">                                     </span>  
 <span class="r4">  549 </span>│       │       │       │       │       │       │              │       │<span class="r7">        y </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">zeros(x</span><span class="r10">.</span><span class="r7">size())</span><span class="r10">.</span><span class="r7">to(</span><span class="r11">&quot;cuda&quot;</span><span class="r7">)</span><span class="r9">      </span>  
 <span class="r4">  550 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r9">                                              </span>  
 <span class="r4">  551 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cmp_results </span><span class="r10">=</span><span class="r7"> x </span><span class="r10">-</span><span class="r7"> y</span><span class="r9">                           </span>  
 <span class="r4">  552 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">if</span><span class="r7"> (cmp_results </span><span class="r10">&lt;=</span><span class="r7"> precision)</span><span class="r10">.</span><span class="r7">all() </span><span class="r10">==</span><span class="r7"> </span><span class="r6">True</span><span class="r7">:</span><span class="r9">  </span>  
 <span class="r4">  553 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> </span><span class="r6">True</span><span class="r9">                               </span>  
 <span class="r4">  554 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">else</span><span class="r7">:</span><span class="r9">                                         </span>  
 <span class="r4">  555 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r6">return</span><span class="r7"> </span><span class="r6">False</span><span class="r9">                              </span>  
 <span class="r4">  556 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  557 </span>│       │       │       │       │       │       │              │       │<span class="r6">def</span><span class="r7"> </span><span class="r13">prepare_data</span><span class="r7">(rdata, rsize):</span><span class="r9">                   </span>  
 <span class="r4">  558 </span>│       │       │       │       │       │       │              │       │<span class="r7">    n </span><span class="r10">=</span><span class="r7"> </span><span class="r12">len</span><span class="r7">(rdata)        </span><span class="r9">                        </span>  
 <span class="r4">  559 </span>│       │       │       │       │       │       │              │       │<span class="r7">    cur_size </span><span class="r10">=</span><span class="r7"> rsize[</span><span class="r10">0</span><span class="r7">]</span><span class="r9">                           </span>  
 <span class="r4">  560 </span>│       │       │       │       │       │       │              │       │<span class="r7">    width, height </span><span class="r10">=</span><span class="r7"> cur_size</span><span class="r9">                      </span>  
 <span class="r4">  561 </span>│       │       │       │       │       │       │              │       │<span class="r7">    width, height </span><span class="r10">=</span><span class="r7"> </span><span class="r12">int</span><span class="r7">(width), </span><span class="r12">int</span><span class="r7">(height)</span><span class="r9">       </span>  
 <span class="r4">  562 </span>│       │       │       │       │       │       │              │       │<span class="r7">    ret_data </span><span class="r10">=</span><span class="r7"> torch</span><span class="r10">.</span><span class="r7">zeros((</span><span class="r10">1</span><span class="r7">, n, width, height))</span><span class="r10">.</span>  
 <span class="r4">  563 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">for</span><span class="r7"> idx </span><span class="r14">in</span><span class="r7"> </span><span class="r12">range</span><span class="r7">(n):</span><span class="r9">                          </span>  
 <span class="r4">  564 </span>│       │       │       │       │       │       │              │       │<span class="r7">        cur_data </span><span class="r10">=</span><span class="r7"> rdata[idx]</span><span class="r9">                     </span>  
 <span class="r4">  565 </span>│       │       │       │       │       │       │              │       │<span class="r7">        </span><span class="r15"># convet (1, 1, 28, 28) to (1, width, heig</span>  
 <span class="r4">  566 </span>│       │       │       │       │       │       │              │       │<span class="r7">        shaped_data </span><span class="r10">=</span><span class="r7"> unpadding(cur_data</span><span class="r10">.</span><span class="r7">reshape(</span><span class="r10">2</span>  
 <span class="r4">  567 </span>│       │       │       │       │       │       │              │       │<span class="r7">        ret_data[</span><span class="r10">0</span><span class="r7">][idx] </span><span class="r10">=</span><span class="r7"> shaped_data</span><span class="r9">            </span>  
 <span class="r4">  568 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r15"># ret_data shape: (1, n, width, height)</span><span class="r9">       </span>  
 <span class="r4">  569 </span>│       │       │       │       │       │       │              │       │<span class="r7">    </span><span class="r6">return</span><span class="r7"> ret_data</span><span class="r9">                               </span>  
 <span class="r4">  570 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
 <span class="r4">  571 </span>│       │       │       │       │       │       │              │       │<span class="r9">                                                  </span>  
       ╵       ╵       ╵       ╵       ╵       ╵       ╵              ╵       ╵                                                    
Top net memory consumption, by line:
<span class="r2">(</span><span class="r17">1</span><span class="r2">)</span>    <span class="r17">14</span>:     <span class="r17">1</span> MB
generated by the <a class="r22" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</pre>
    </code>
</body>
</html>
